import{r as a,j as e,B as f,T as x,d as A,I as E,M as h,t as M,D as R,H as $}from"./index-DNJ-7_Rf.js";import{C as B}from"./config-global-CwnLHF89.js";import{T as S}from"./TextField-DrqQKz-z.js";import{I as O}from"./InputAdornment-CuTnuXim.js";import{S as W,F as H,I as V,O as z}from"./Select-C6NYPjTS.js";import{L as _}from"./LoadingButton-ibHk8LjJ.js";import{f as J}from"./users-Dd3MPzKO.js";import{b as X}from"./iot-Dg2SjAsq.js";import{C as q}from"./Chip-BXj8O4Gd.js";import{T as G,a as k}from"./Tabs-D274aWzn.js";import"./useControlled-CYejl48w.js";import"./CircularProgress-DypZclCl.js";import"./KeyboardArrowRight-DgOaYwjI.js";function K(){const[t,d]=a.useState(""),[n,c]=a.useState(""),[i,C]=a.useState(""),[m,w]=a.useState(1),[b,u]=a.useState(""),[j,P]=a.useState(""),[v,p]=a.useState(!1),[y,g]=a.useState(!1),o=(s,r)=>{r(s),setTimeout(()=>{r("")},3e3)},U=async()=>{if(!t||!n||!i){o("Ingrese un nombre, correo electrónico y una contraseña",u);return}if(!/\S+@\S+\.\S+/.test(n)){o("Ingrese un correo electrónico válido",u);return}try{g(!0);const r=await(await fetch(`${M}/api/users/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:t,correo:n,contraseña:i,tipo_usuario:m})})).json();if(r.message==="Usuario creado exitosamente"){o(r.message,P),g(!1);return}(r==null?void 0:r.errors[0])==="correo must be unique"&&(o("El usuario ya existe",u),g(!1))}catch{o("Error al crear el usuario",u),g(!1)}},T=e.jsxs(f,{display:"flex",flexDirection:"column",alignItems:"flex-end",marginX:"auto",width:{xs:"90%",sm:"80%",md:"60%",lg:"50%"},children:[e.jsx(S,{fullWidth:!0,name:"name",label:"Nombre",InputLabelProps:{shrink:!0},sx:{mb:3},value:t,onChange:s=>d(s.target.value)}),e.jsx(S,{fullWidth:!0,name:"email",label:"Correo",InputLabelProps:{shrink:!0},sx:{mb:3},value:n,onChange:s=>c(s.target.value)}),e.jsx(S,{fullWidth:!0,name:"password",label:"Contraseña",InputLabelProps:{shrink:!0},type:v?"text":"password",InputProps:{endAdornment:e.jsx(O,{position:"end",children:e.jsx(A,{onClick:()=>p(!v),edge:"end",children:e.jsx(E,{icon:v?"solar:eye-bold":"solar:eye-closed-bold"})})})},sx:{mb:3},value:i,onChange:s=>C(s.target.value)}),e.jsxs(W,{fullWidth:!0,name:"role",sx:{mb:3},value:m,onChange:s=>w(s.target.value),children:[e.jsx(h,{value:1,children:"User"}),e.jsx(h,{value:2,children:"Admin"}),e.jsx(h,{value:3,children:"Superadmin"})]}),b&&e.jsx(x,{variant:"body2",color:"error",sx:{mb:1.5},children:b}),j&&e.jsx(x,{variant:"body2",color:"green",sx:{mb:1.5},children:j}),e.jsx(_,{fullWidth:!0,size:"large",type:"submit",color:"inherit",variant:"contained",onClick:U,loading:y,children:"Crear Usuario"})]});return e.jsxs(e.Fragment,{children:[e.jsx(f,{gap:1.5,display:"flex",flexDirection:"column",alignItems:"center",sx:{mt:5},children:e.jsx(x,{variant:"h6",children:"Nuevo Usuario"})}),T]})}function Q(){const[t,d]=a.useState(""),[n,c]=a.useState(""),[i,C]=a.useState(1),[m,w]=a.useState([]),[b,u]=a.useState(""),[j,P]=a.useState(""),[v,p]=a.useState(!1),[y,g]=a.useState([]);a.useEffect(()=>{(async()=>{try{const l=await(await fetch(`${M}/api/sensors/ultima-medicion-unica`)).json();g(l)}catch(r){console.error("Failed to fetch data:",r)}})()},[]);const o=(s,r)=>{r(s),setTimeout(()=>{r("")},3e3)},U=async()=>{var s;if(!t||!n){o("Ingrese un nombre, correo electrónico y una contraseña",u);return}if(!/\S+@\S+\.\S+/.test(n)){o("Ingrese un correo electrónico válido",u);return}try{p(!0);const l=await(await fetch(`${M}/api/users/special-create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nombre:t,correo:n,tipo_usuario:i,sensor_ids:m})})).json();if(l.message==="Usuario creado. Se envió un correo con instrucciones para establecer la contraseña."&&(o(l.message,P),p(!1)),(l==null?void 0:l.message)==="Error al crear el usuario"){o("El usuario ya existe o ha ocurrido un error",u),p(!1);return}if(m.length>=1){const I=await J();if(I.length===0)return;const F=(s=I.find(N=>N.correo===n))==null?void 0:s.id;if(!F)return;await Promise.all(m.map(async N=>{await X(N,F)}))}}catch{o("Error al crear el usuario",u),p(!1)}},T=e.jsxs(f,{display:"flex",flexDirection:"column",alignItems:"flex-end",marginX:"auto",width:{xs:"90%",sm:"80%",md:"60%",lg:"50%"},children:[e.jsx(S,{fullWidth:!0,name:"name",label:"Nombre",InputLabelProps:{shrink:!0},sx:{mb:3},value:t,onChange:s=>d(s.target.value)}),e.jsx(S,{fullWidth:!0,name:"email",label:"Correo",InputLabelProps:{shrink:!0},sx:{mb:3},value:n,onChange:s=>c(s.target.value)}),e.jsxs(W,{fullWidth:!0,name:"role",sx:{mb:3},value:i,onChange:s=>C(s.target.value),children:[e.jsx(h,{value:1,children:"User"}),e.jsx(h,{value:2,children:"Admin"}),e.jsx(h,{value:3,children:"Superadmin"})]}),e.jsxs(H,{fullWidth:!0,sx:{mb:3},children:[e.jsx(V,{id:"sensor-select-label",children:"Sensores"}),e.jsx(W,{labelId:"sensor-select-label",multiple:!0,value:m,onChange:s=>w(s.target.value),input:e.jsx(z,{label:"Sensores"}),renderValue:s=>e.jsx(f,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.map(r=>{var l;return e.jsx(q,{label:((l=y.find(I=>I.dispositivo_id===r))==null?void 0:l.nombre_dispositivo)||r},r)})}),children:y.map(s=>e.jsx(h,{value:s.dispositivo_id,children:s.nombre_dispositivo||s.dispositivo_id},s.id))})]}),b&&e.jsx(x,{variant:"body2",color:"error",sx:{mb:1.5},children:b}),j&&e.jsx(x,{variant:"body2",color:"green",sx:{mb:1.5},children:j}),e.jsx(_,{fullWidth:!0,size:"large",type:"submit",color:"inherit",variant:"contained",onClick:U,loading:v,children:"Crear Usuario"})]});return e.jsxs(e.Fragment,{children:[e.jsx(f,{gap:1.5,display:"flex",flexDirection:"column",alignItems:"center",sx:{mt:5},children:e.jsx(x,{variant:"h6",children:"Pre-registrar usuario"})}),T]})}const Y=()=>{const[t,d]=a.useState(0),n=(c,i)=>{d(i)};return e.jsxs(R,{children:[e.jsx(x,{variant:"h4",children:"Usuarios"}),e.jsxs(G,{value:t,onChange:n,"aria-label":"vistas-disponibles",sx:{mt:3},children:[e.jsx(k,{label:"Nuevo",...D(0),sx:{borderRadius:1,marginBottom:.5},icon:e.jsx(E,{icon:"solar:user-plus-bold-duotone"}),iconPosition:"start"}),e.jsx(k,{label:"Invitar",...D(1),sx:{borderRadius:1,marginBottom:.5},icon:e.jsx(E,{icon:"solar:file-right-broken"}),iconPosition:"start"})]}),e.jsx(L,{value:t,index:0,children:e.jsx(K,{})}),e.jsx(L,{value:t,index:1,children:e.jsx(Q,{})})]})};function D(t){return{id:`simple-tab-${t}`,"aria-controls":`simple-tabpanel-${t}`}}function L(t){const{children:d,value:n,index:c,...i}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==c,id:`vista-${c}`,"aria-labelledby":`vista-${c}`,...i,children:n===c&&e.jsx(f,{sx:{mt:2},children:d})})}function me(){return e.jsxs(e.Fragment,{children:[e.jsx($,{children:e.jsxs("title",{children:[" ",`Nuevo usuario - ${B.appName}`]})}),e.jsx(Y,{})]})}export{me as default};
