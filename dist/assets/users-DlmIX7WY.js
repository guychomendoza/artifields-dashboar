import{g as V,e as Q,s as X,_ as A,r as n,f as Y,k as Z,aA as ee,j as e,o as te,p as se,T as h,v as P,F as R,B as j,d as v,I as S,M as L,y as N,az as F,L as G,E as ae,t as re,D as oe,H as ne}from"./index-DNJ-7_Rf.js";import{C as ie}from"./config-global-CwnLHF89.js";import{u as le,d as ce,c as de,f as me,a as xe}from"./users-Dd3MPzKO.js";import{u as he}from"./use-debounce-BKmKytjS.js";import{T as w}from"./TextField-DrqQKz-z.js";import{D as ue,a as fe,b as pe}from"./DialogContent-DmUc9Cb3.js";import{D as ge}from"./DialogTitle-m1-UEW8M.js";import{C as U}from"./Card-98N49c-B.js";import{S as je}from"./Select-C6NYPjTS.js";import{T as E}from"./Tooltip-DbXBuVyG.js";import{F as be,S as Ce}from"./Switch-CwwqqYuk.js";import{L as T}from"./LoadingButton-ibHk8LjJ.js";import{L as O}from"./ListItemText-C9xeFpMB.js";import{S as k}from"./Stack-BvggcJT0.js";import{C as ve}from"./Chip-BXj8O4Gd.js";import{C as z}from"./CardContent-DR76uJN9.js";import{S as Se}from"./Snackbar-Ca286brL.js";import"./useControlled-CYejl48w.js";import"./Popper-yRRR-Rwr.js";import"./SwitchBase-DJ_sWzg7.js";import"./CircularProgress-DypZclCl.js";function ye(t){return Q("MuiListItemAvatar",t)}V("MuiListItemAvatar",["root","alignItemsFlexStart"]);const we=["className"],Ee=t=>{const{alignItems:r,classes:s}=t;return se({root:["root",r==="flex-start"&&"alignItemsFlexStart"]},ye,s)},Ue=X("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(t,r)=>{const{ownerState:s}=t;return[r.root,s.alignItems==="flex-start"&&r.alignItemsFlexStart]}})(({ownerState:t})=>A({minWidth:56,flexShrink:0},t.alignItems==="flex-start"&&{marginTop:8})),B=n.forwardRef(function(r,s){const a=Y({props:r,name:"MuiListItemAvatar"}),{className:l}=a,c=Z(a,we),i=n.useContext(ee),m=A({},a,{alignItems:i.alignItems}),o=Ee(m);return e.jsx(Ue,A({className:te(o.root,l),ownerState:m,ref:s},c))}),Ie=({onSearch:t})=>{const[r,s]=n.useState(""),a=he(r,500);return n.useEffect(()=>{t(a)},[a,t]),e.jsx(w,{fullWidth:!0,placeholder:"Buscar usuario",value:r,onChange:l=>s(l.target.value)})},Te=({open:t,onClose:r,onConfirm:s})=>e.jsxs(ue,{open:t,onClose:r,children:[e.jsx(ge,{children:"Confirmación"}),e.jsx(fe,{children:e.jsx(h,{children:"¿Estás seguro que deseas activar el chatbot de WhatsApp para este usuario?"})}),e.jsxs(pe,{children:[e.jsx(P,{onClick:r,color:"inherit",children:"Cancelar"}),e.jsx(P,{onClick:s,variant:"contained",color:"primary",children:"Confirmar"})]})]}),De={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},Le=({open:t,handleClose:r,user:s,refetchData:a})=>{const[l,c]=n.useState(""),[i,m]=n.useState(""),[o,d]=n.useState(""),[p,x]=n.useState(1),[u,b]=n.useState(!1),[C,D]=n.useState(!1),[_,g]=n.useState(""),[M,W]=n.useState(""),[q,I]=n.useState(!1);n.useEffect(()=>{s&&(c(s.nombre||""),m(s.correo||""),d(s.telefono||""),x(s.tipo_usuario||1),b(s.chatbot_whats||!1))},[s]);const H=f=>{if(!o.trim()){g("Se requiere un número de teléfono para activar el chatbot"),setTimeout(()=>{g("")},3e3);return}f.target.checked?D(!0):b(!1)},$=()=>{b(!0),D(!1)},J=()=>{D(!1),b(!1)},K=async()=>{if(!(!s||!s.id)){if(!l||!i||!p){g("El nombre, correo y rol son requeridos"),setTimeout(()=>{g("")},3e3);return}if(u&&!o.trim()){g("Se requiere un número de teléfono para activar el chatbot"),b(!1),setTimeout(()=>{g("")},3e3);return}if(!(l===(s==null?void 0:s.nombre)&&i===(s==null?void 0:s.correo)&&p===(s==null?void 0:s.tipo_usuario)&&o===(s==null?void 0:s.telefono)&&u===(s==null?void 0:s.chatbot_whats))){I(!0);try{if(!await le(s.id,{nombre:l,correo:i,tipo_usuario:p,telefono:o,chatbot_whats:u})){g("Error al actualizar los detalles del usuario"),setTimeout(()=>{g("")},3e3),I(!1);return}W("Detalles del usuario actualizados correctamente"),a(),I(!1),setTimeout(()=>{W("")},3e3)}catch{g("Error al actualizar los detalles del usuario"),setTimeout(()=>{g("")},3e3),I(!1)}}}};return e.jsxs(e.Fragment,{children:[e.jsx(R,{open:t,onClose:r,"aria-labelledby":"child-modal-title","aria-describedby":"child-modal-description",children:e.jsxs(U,{sx:{...De,width:{xs:"90%",sm:400,md:500,lg:600}},children:[e.jsxs(j,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"h5",flexGrow:1,children:"Editar usuario"}),e.jsx(v,{onClick:r,children:e.jsx(S,{icon:"eva:close-fill"})})]}),e.jsx(w,{fullWidth:!0,label:"Nombre",margin:"normal",variant:"outlined",value:l,onChange:f=>c(f.target.value)}),e.jsx(w,{fullWidth:!0,label:"Correo",margin:"normal",variant:"outlined",value:i,onChange:f=>m(f.target.value)}),e.jsx(w,{fullWidth:!0,label:"Teléfono",margin:"normal",variant:"outlined",value:o,onChange:f=>{d(f.target.value),!f.target.value.trim()&&u&&b(!1)}}),e.jsxs(je,{fullWidth:!0,name:"role",sx:{mb:3},value:p,onChange:f=>x(f.target.value),children:[e.jsx(L,{value:1,children:"User"}),e.jsx(L,{value:2,children:"Admin"}),e.jsx(L,{value:3,children:"Superadmin"})]}),e.jsx(E,{title:o.trim()?"":"Se requiere un número de teléfono para activar el chatbot",children:e.jsx(be,{control:e.jsx(Ce,{checked:u,onChange:H,color:"primary",disabled:!o.trim()}),label:"Activar Chatbot de WhatsApp"})}),_&&e.jsx(h,{color:"error",variant:"body2",sx:{mt:1},children:_}),M&&e.jsx(h,{color:"green",variant:"body2",sx:{mt:1},children:M}),e.jsx(T,{fullWidth:!0,variant:"contained",color:"primary",onClick:K,loading:q,sx:{mt:2},children:"Actualizar usuario"})]})}),e.jsx(Te,{open:C,onClose:J,onConfirm:$})]})};var y=(t=>(t.CHANGE_PASSWORD="CHANGE_PASSWORD",t.EDIT_USER="EDIT_USER",t.DELETE_USER="DELETE_USER",t))(y||{});const Ae={1:["ver"],2:["ver","editar","asignar"],3:["ver","editar","asignar","usuarios","login"]},Re=({user:t,setSelectedUser:r,refetch:s,setSelectedModal:a,idx:l})=>{var i,m;const c=Ae[t.tipo_usuario]||[];return e.jsxs(N,{sx:{display:"flex",flexDirection:"column",alignItems:"stretch",width:"100%",px:2,py:1},children:[e.jsxs(j,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},alignItems:{xs:"flex-start",sm:"center"},width:"100%",mb:1},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",flexGrow:1},children:[e.jsx(h,{variant:"body2",sx:{mr:1},children:l}),e.jsx(B,{children:e.jsxs(F,{sx:{bgcolor:o=>o.palette.primary.main},children:[(i=t==null?void 0:t.nombre[0])==null?void 0:i.toUpperCase(),(m=t==null?void 0:t.nombre[1])==null?void 0:m.toUpperCase()]})}),e.jsx(O,{primary:t.nombre,secondary:t.correo})]}),e.jsx(j,{sx:{mt:{xs:1,sm:0},display:"flex",alignItems:"center",justifyContent:{xs:"space-between",sm:"flex-end"},width:{xs:"100%",sm:"auto"}},children:e.jsxs(k,{direction:"row",spacing:2,children:[e.jsx(E,{title:"Cambiar contraseña",children:e.jsx(v,{"aria-label":"cambiar contraseña",onClick:()=>{r(t),a(y.CHANGE_PASSWORD)},children:e.jsx(S,{icon:"solar:lock-password-unlocked-bold"})})}),e.jsx(E,{title:"Editar usuario",children:e.jsx(v,{"aria-label":"edit user",onClick:()=>{r(t),a(y.EDIT_USER)},children:e.jsx(S,{icon:"solar:pen-bold"})})}),e.jsx(E,{title:"Eliminar usuario",children:e.jsx(v,{color:"error","aria-label":"delete user",onClick:()=>{r(t),a(y.DELETE_USER)},children:e.jsx(S,{icon:"solar:trash-bin-2-bold"})})})]})})]}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,width:"100%",justifyContent:"flex-start"},children:c.map(o=>e.jsx(ve,{label:o,size:"small",color:"default",sx:{backgroundColor:d=>d.palette.grey[300],color:d=>d.palette.text.secondary,fontSize:"0.675rem"}},o))})]},t.id)},ke={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},_e=({refetchData:t,open:r,handleClose:s,user:a})=>{const[l,c]=n.useState(""),[i,m]=n.useState(""),[o,d]=n.useState(!1),p=async x=>{if(!x){c("Usuario no encontrado"),setTimeout(()=>{c("")},3e3);return}if(d(!0),!await ce(x)){c("Error al eliminar el usuario"),d(!1),setTimeout(()=>{c("")},3e3);return}m("Usuario eliminado correctamente"),setTimeout(()=>{m(""),d(!1),s()},1500),t()};return e.jsx(R,{open:r,onClose:s,"aria-labelledby":"child-modal-title","aria-describedby":"child-modal-description",children:e.jsxs(U,{sx:{...ke,width:{xs:"90%",sm:400,md:500,lg:600}},children:[e.jsx(j,{display:"flex",alignItems:"center",justifyContent:"flex-end",children:e.jsx(v,{onClick:s,children:e.jsx(S,{icon:"eva:close-fill"})})}),e.jsxs(h,{variant:"h5",flexGrow:1,children:["Estas seguro de eliminar el usuario ",a==null?void 0:a.nombre,", esta acción no se puede deshacer."]}),l&&e.jsx(h,{color:"error",variant:"body2",children:l}),i&&e.jsx(h,{color:"green",variant:"body2",children:i}),e.jsxs(k,{spacing:2,direction:"row",mt:3,children:[e.jsx(T,{fullWidth:!0,variant:"outlined",color:"primary",onClick:s,loading:o,children:"Cancelar"}),e.jsx(T,{fullWidth:!0,variant:"contained",color:"error",onClick:()=>p(a==null?void 0:a.id),loading:o,children:"Eliminar usuario"})]})]})})},Me={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},We=({open:t,handleClose:r,user:s})=>{const[a,l]=n.useState(""),[c,i]=n.useState(""),[m,o]=n.useState(""),[d,p]=n.useState(""),[x,u]=n.useState(!1),b=async()=>{if(!s||!s.id){o("Usuario no encontrado"),setTimeout(()=>{o("")},3e3);return}if(!a||!c){o("Ambos campos de contraseña deben ser llenados"),setTimeout(()=>{o("")},3e3);return}if(a!==c){o("Las contraseñas no coinciden"),setTimeout(()=>{o("")},3e3);return}u(!0);try{if(!await de(s.id,a)){o("Error al cambiar la contraseña"),setTimeout(()=>{o("")},3e3),u(!1),l(""),i("");return}p("Contraseña cambiada correctamente"),setTimeout(()=>{p("")},3e3),u(!1),l(""),i("")}catch{o("Error al cambiar la contraseña"),setTimeout(()=>{o("")},3e3),u(!1)}};return e.jsx(R,{open:t,onClose:r,"aria-labelledby":"child-modal-title","aria-describedby":"child-modal-description",children:e.jsxs(U,{sx:{...Me,width:{xs:"90%",sm:400,md:500,lg:600}},children:[e.jsxs(j,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(h,{variant:"h5",flexGrow:1,children:"Nueva contraseña"}),e.jsx(v,{onClick:r,children:e.jsx(S,{icon:"eva:close-fill"})})]}),e.jsx(w,{fullWidth:!0,label:"Nueva contraseña",type:"password",margin:"normal",variant:"outlined",value:a,onChange:C=>l(C.target.value)}),e.jsx(w,{fullWidth:!0,label:"Confirmar contraseña",type:"password",margin:"normal",variant:"outlined",value:c,onChange:C=>i(C.target.value)}),m&&e.jsx(h,{color:"error",variant:"body2",children:m}),d&&e.jsx(h,{color:"green",variant:"body2",children:d}),e.jsx(T,{fullWidth:!0,variant:"contained",color:"primary",onClick:b,loading:x,children:"Cambiar contraseña"})]})})},Pe=()=>{const[t,r]=n.useState([]),[s,a]=n.useState(""),[l,c]=n.useState(null),[i,m]=n.useState(null),o=()=>m(null),d=n.useCallback(async()=>{const x=await me();x.length&&r(x)},[]);n.useEffect(()=>{d()},[d]);const p=s?t.filter(x=>x.nombre.toLowerCase().includes(s)||x.correo.toLowerCase().includes(s)):t;return e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"h6",mt:5,children:"Usuarios Registrados"}),e.jsxs(U,{sx:{mt:1},children:[e.jsx(j,{sx:{p:1},children:e.jsx(Ie,{onSearch:a})}),e.jsx(z,{children:e.jsx(G,{children:p.map((x,u)=>e.jsx(Re,{user:x,setSelectedUser:c,refetch:d,setSelectedModal:m,idx:u+1},x.id))})})]}),e.jsx(We,{open:i===y.CHANGE_PASSWORD,handleClose:o,user:l}),e.jsx(_e,{open:i===y.DELETE_USER,handleClose:o,user:l,refetchData:d}),e.jsx(Le,{open:i===y.EDIT_USER,handleClose:o,user:l,refetchData:d})]})},Ne=({user:t})=>{var l,c;const[r,s]=n.useState(null),a=async()=>{if(!(!t||!t.correo))try{(await(await fetch(`${re}/api/users/resend-reset-token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({correo:t.correo})})).json()).message==="Nueva URL enviada al correo electrónico."&&(s("Correo reenviado correctamente"),setTimeout(()=>s(null),3e3))}catch(i){console.log(i)}};return e.jsxs(e.Fragment,{children:[e.jsxs(N,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},alignItems:{xs:"flex-start",sm:"center"}},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[e.jsx(B,{children:e.jsxs(F,{sx:{bgcolor:i=>i.palette.primary.main},children:[(l=t==null?void 0:t.nombre[0])==null?void 0:l.toUpperCase(),(c=t==null?void 0:t.nombre[1])==null?void 0:c.toUpperCase()]})}),e.jsx(O,{primary:t.nombre,secondary:t.correo})]}),e.jsx(j,{sx:{mt:{xs:1,sm:0},width:{xs:"100%",sm:"auto"},display:"flex",justifyContent:{xs:"space-between",sm:"flex-end"}},children:e.jsx(k,{direction:"row",spacing:2,children:e.jsx(E,{title:"Reenviar código",children:e.jsx(v,{"aria-label":"Reenviar código",onClick:a,children:e.jsx(S,{icon:"solar:chat-square-arrow-bold-duotone"})})})})})]},t.id),r&&e.jsx(Se,{open:!!r,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(ae,{severity:"success",sx:{width:"100%"},children:r})})]})},Fe=()=>{const[t,r]=n.useState([]),s=n.useCallback(async()=>{const a=await xe();a.length&&r(a)},[]);return n.useEffect(()=>{s()},[s]),e.jsx(e.Fragment,{children:t.length>=1?e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"h6",mt:5,children:"Usuarios pre-registrados"}),e.jsx(U,{sx:{mt:1},children:e.jsx(z,{children:e.jsx(G,{children:t.map(a=>e.jsx(Ne,{user:a},a.id))})})})]}):null})};function Ge(){return e.jsxs(oe,{children:[e.jsx(h,{variant:"h4",children:"Usuarios"}),e.jsx(Pe,{}),e.jsx(Fe,{})]})}function lt(){return e.jsxs(e.Fragment,{children:[e.jsx(ne,{children:e.jsxs("title",{children:[" ",`Sign in - ${ie.appName}`]})}),e.jsx(Ge,{})]})}export{lt as default};
