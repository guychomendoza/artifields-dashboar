import{s as X,j as p,T as O,I as ht,B as T,l as pt,az as gt,z as mt,r as v,S as xt}from"./index-DNJ-7_Rf.js";import{u as bt}from"./useQuery-Cikl35b1.js";import{f as yt}from"./utils-DgT3aVHO.js";import{n as $}from"./charts-CQznrqcz.js";import{C as tt}from"./Card-98N49c-B.js";import{C as Mt}from"./CardHeader-BODd0mTE.js";import{T as wt}from"./Tooltip-DbXBuVyG.js";import{S as Ct}from"./Slider-CXET07Dr.js";import{u as kt}from"./useMediaQuery-BWWVbJPQ.js";import{S as vt}from"./Stack-BvggcJT0.js";import{G as A}from"./Grid-BaR81AYS.js";import{S as nt,E as it}from"./index-DnZn71We.js";import{c as Et,u as jt,I as _t,M as Lt}from"./index.modern-BSJ2A2Eu.js";import{$ as st}from"./index-KKIBTe8w.js";import{R as It,g as At}from"./admin-clusters-CbYe47uX.js";const St=X("div")(()=>({position:"absolute",display:"flex",alignItems:"center",right:0,transform:"translateY(-50%)"})),Pt=X("div")(({color:o})=>({width:"3rem",borderTop:`2px dashed ${o}`})),Tt=X("span")(({color:o})=>({marginLeft:"8px",fontSize:"0.75rem",color:o})),Ot=({bottomLimit:o=null,topLimit:t=null,soilMoisture:e,lastMeasurement:r,name:n,desiredValue:i,deviceId:l})=>{const u=[o?{value:$(o,50,10),color:"#ff0000",label:`${o}`,condition:o>=10}:{},t?{value:$(t,50,10),color:"#0b2af1",label:`${t}`,condition:t<=50}:{}].filter(f=>!!(f!=null&&f.condition));return p.jsxs(tt,{sx:{width:"100%",position:"relative",height:"100%"},children:[p.jsx(Mt,{title:p.jsx(wt,{title:l,children:p.jsx(O,{fontWeight:"500",children:n||"sin nombre"})}),subheader:`${yt(r)}`,sx:{padding:1.5,paddingBottom:0},titleTypographyProps:{variant:"body1",fontWeight:"medium"},subheaderTypographyProps:{variant:"body2",fontSize:"0.75rem"},avatar:p.jsx(ht,{icon:"solar:waterdrops-line-duotone"})}),p.jsxs(T,{px:3,height:200,display:"flex",alignItems:"center",justifyContent:"center",position:"relative",my:2,sx:{paddingLeft:8},children:[u.length>0&&p.jsx(T,{position:"absolute",height:"90%",right:"30%",sx:{transform:"translateX(12px)"},children:u.map(({value:f,color:c,label:m})=>p.jsx(T,{position:"absolute",style:{bottom:`${f}%`,width:"100%"},children:p.jsxs(St,{color:c,children:[p.jsx(Pt,{color:c}),p.jsx(Tt,{color:c,children:m})]})},m))}),e!=null?p.jsx(Ct,{track:!1,marks:[{value:0,label:"10%"},i?{value:$(i,50,10),label:`${i}%`}:{value:0},{value:100,label:"50%"}].filter(Boolean),orientation:"vertical",value:$(e,50,10),valueLabelFormat:()=>e,disabled:!0,valueLabelDisplay:"on",sx:{height:"90%",width:8,"& .MuiSlider-rail":{background:"linear-gradient(to top, #f10b0b, #f1ee0b, #0b2af1)",opacity:1},"& .MuiSlider-thumb":{backgroundColor:"#fff",border:"2px solid currentColor",width:16,height:16},"& .MuiSlider-valueLabel":{backgroundColor:"white",color:"black",borderRadius:"4px",padding:"4px 8px",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",borderColor:"white",border:"1px solid #EBEBEB"}}}):p.jsx(O,{variant:"body1",color:"text.secondary",sx:{marginRight:8},children:"Sin datos"})]})]})},Rt=({name:o,sensors:t})=>{const e=pt(),r=kt(e.breakpoints.down("sm"));return p.jsxs(tt,{sx:{p:1,mb:2,borderRadius:3,border:"1px dashed",borderColor:"rgba(0,0,0,0.1)",backgroundColor:"rgba(255,255,255,0.5)",boxShadow:"0 0 1px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.05)"},children:[p.jsxs(vt,{direction:"row",alignItems:"center",spacing:1,mb:2,children:[p.jsx(gt,{sx:{bgcolor:"primary.main"},children:p.jsx(ht,{icon:"uim:object-group"})}),p.jsx(O,{variant:"h6",children:o||"Parcela sin nombre"})]}),p.jsxs(A,{container:!0,spacing:r?1:2,children:[t.length===0||t.every(n=>(n==null?void 0:n.info)===null&&(n==null?void 0:n.lastMeasurement)===null)&&p.jsx(T,{sx:{py:2,px:3},children:p.jsx(O,{variant:"caption",children:"Parcela sin sensores"})}),t.map(n=>{var i,l,h,s,u,f,c,m,a;if(!(!(n!=null&&n.info)||!(n!=null&&n.lastMeasurement)))return p.jsx(A,{item:!0,xs:6,children:p.jsx(mt,{to:`/iot/sensor/${(i=n==null?void 0:n.info)==null?void 0:i.deviceId}`,style:{textDecoration:"none",color:"inherit"},children:p.jsx(Ot,{soilMoisture:(l=n==null?void 0:n.lastMeasurement)==null?void 0:l.soilMoisture,name:((h=n==null?void 0:n.info)==null?void 0:h.name)||"Sin nombre",lastMeasurement:(s=n==null?void 0:n.lastMeasurement)==null?void 0:s.timestamp,deviceId:(u=n==null?void 0:n.info)==null?void 0:u.deviceId,bottomLimit:(f=n==null?void 0:n.info)==null?void 0:f.bottomLimit,topLimit:(c=n==null?void 0:n.info)==null?void 0:c.topLimit,desiredValue:(m=n==null?void 0:n.info)==null?void 0:m.idalCapacity})})},(a=n==null?void 0:n.info)==null?void 0:a.deviceId)})]})]})},Bt=()=>p.jsxs(A,{container:!0,sx:{height:"calc(100vh - 180px)"},spacing:2,children:[p.jsx(A,{item:!0,xs:12,md:6,children:p.jsx(nt,{variant:"rectangular",height:"100%",sx:{borderRadius:1}})}),p.jsx(A,{item:!0,xs:12,md:6,children:p.jsx(nt,{variant:"rectangular",height:"100%",sx:{borderRadius:1}})})]}),ot=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],K=1,B=8;class et{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[e,r]=new Uint8Array(t,0,2);if(e!==219)throw new Error("Data does not appear to be in a KDBush format.");const n=r>>4;if(n!==K)throw new Error(`Got v${n} data when expected v${K}.`);const i=ot[r&15];if(!i)throw new Error("Unrecognized array type.");const[l]=new Uint16Array(t,2,1),[h]=new Uint32Array(t,4,1);return new et(h,l,i,t)}constructor(t,e=64,r=Float64Array,n){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.ArrayType=r,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const i=ot.indexOf(this.ArrayType),l=t*2*this.ArrayType.BYTES_PER_ELEMENT,h=t*this.IndexArrayType.BYTES_PER_ELEMENT,s=(8-h%8)%8;if(i<0)throw new Error(`Unexpected typed array class: ${r}.`);n&&n instanceof ArrayBuffer?(this.data=n,this.ids=new this.IndexArrayType(this.data,B,t),this.coords=new this.ArrayType(this.data,B+h+s,t*2),this._pos=t*2,this._finished=!0):(this.data=new ArrayBuffer(B+l+h+s),this.ids=new this.IndexArrayType(this.data,B,t),this.coords=new this.ArrayType(this.data,B+h+s,t*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(K<<4)+i]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t)}add(t,e){const r=this._pos>>1;return this.ids[r]=r,this.coords[this._pos++]=t,this.coords[this._pos++]=e,r}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return J(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,e,r,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:i,coords:l,nodeSize:h}=this,s=[0,i.length-1,0],u=[];for(;s.length;){const f=s.pop()||0,c=s.pop()||0,m=s.pop()||0;if(c-m<=h){for(let x=m;x<=c;x++){const b=l[2*x],w=l[2*x+1];b>=t&&b<=r&&w>=e&&w<=n&&u.push(i[x])}continue}const a=m+c>>1,d=l[2*a],g=l[2*a+1];d>=t&&d<=r&&g>=e&&g<=n&&u.push(i[a]),(f===0?t<=d:e<=g)&&(s.push(m),s.push(a-1),s.push(1-f)),(f===0?r>=d:n>=g)&&(s.push(a+1),s.push(c),s.push(1-f))}return u}within(t,e,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:n,coords:i,nodeSize:l}=this,h=[0,n.length-1,0],s=[],u=r*r;for(;h.length;){const f=h.pop()||0,c=h.pop()||0,m=h.pop()||0;if(c-m<=l){for(let x=m;x<=c;x++)at(i[2*x],i[2*x+1],t,e)<=u&&s.push(n[x]);continue}const a=m+c>>1,d=i[2*a],g=i[2*a+1];at(d,g,t,e)<=u&&s.push(n[a]),(f===0?t-r<=d:e-r<=g)&&(h.push(m),h.push(a-1),h.push(1-f)),(f===0?t+r>=d:e+r>=g)&&(h.push(a+1),h.push(c),h.push(1-f))}return s}}function J(o,t,e,r,n,i){if(n-r<=e)return;const l=r+n>>1;ut(o,t,l,r,n,i),J(o,t,e,r,l-1,1-i),J(o,t,e,l+1,n,1-i)}function ut(o,t,e,r,n,i){for(;n>r;){if(n-r>600){const u=n-r+1,f=e-r+1,c=Math.log(u),m=.5*Math.exp(2*c/3),a=.5*Math.sqrt(c*m*(u-m)/u)*(f-u/2<0?-1:1),d=Math.max(r,Math.floor(e-f*m/u+a)),g=Math.min(n,Math.floor(e+(u-f)*m/u+a));ut(o,t,e,d,g,i)}const l=t[2*e+i];let h=r,s=n;for(Z(o,t,r,e),t[2*n+i]>l&&Z(o,t,r,n);h<s;){for(Z(o,t,h,s),h++,s--;t[2*h+i]<l;)h++;for(;t[2*s+i]>l;)s--}t[2*r+i]===l?Z(o,t,r,s):(s++,Z(o,t,s,n)),s<=e&&(r=s+1),e<=s&&(n=s-1)}}function Z(o,t,e,r){Y(o,e,r),Y(t,2*e,2*r),Y(t,2*e+1,2*r+1)}function Y(o,t,e){const r=o[t];o[t]=o[e],o[e]=r}function at(o,t,e,r){const n=o-e,i=t-r;return n*n+i*i}const Zt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:o=>o},lt=Math.fround||(o=>t=>(o[0]=+t,o[0]))(new Float32Array(1)),P=2,I=3,Q=4,L=5,dt=6;class Ft{constructor(t){this.options=Object.assign(Object.create(Zt),t),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(t){const{log:e,minZoom:r,maxZoom:n}=this.options;e&&console.time("total time");const i=`prepare ${t.length} points`;e&&console.time(i),this.points=t;const l=[];for(let s=0;s<t.length;s++){const u=t[s];if(!u.geometry)continue;const[f,c]=u.geometry.coordinates,m=lt(U(f)),a=lt(N(c));l.push(m,a,1/0,s,-1,1),this.options.reduce&&l.push(0)}let h=this.trees[n+1]=this._createTree(l);e&&console.timeEnd(i);for(let s=n;s>=r;s--){const u=+Date.now();h=this.trees[s]=this._createTree(this._cluster(h,s)),e&&console.log("z%d: %d clusters in %dms",s,h.numItems,+Date.now()-u)}return e&&console.timeEnd("total time"),this}getClusters(t,e){let r=((t[0]+180)%360+360)%360-180;const n=Math.max(-90,Math.min(90,t[1]));let i=t[2]===180?180:((t[2]+180)%360+360)%360-180;const l=Math.max(-90,Math.min(90,t[3]));if(t[2]-t[0]>=360)r=-180,i=180;else if(r>i){const c=this.getClusters([r,n,180,l],e),m=this.getClusters([-180,n,i,l],e);return c.concat(m)}const h=this.trees[this._limitZoom(e)],s=h.range(U(r),N(l),U(i),N(n)),u=h.data,f=[];for(const c of s){const m=this.stride*c;f.push(u[m+L]>1?ct(u,m,this.clusterProps):this.points[u[m+I]])}return f}getChildren(t){const e=this._getOriginId(t),r=this._getOriginZoom(t),n="No cluster with the specified id.",i=this.trees[r];if(!i)throw new Error(n);const l=i.data;if(e*this.stride>=l.length)throw new Error(n);const h=this.options.radius/(this.options.extent*Math.pow(2,r-1)),s=l[e*this.stride],u=l[e*this.stride+1],f=i.within(s,u,h),c=[];for(const m of f){const a=m*this.stride;l[a+Q]===t&&c.push(l[a+L]>1?ct(l,a,this.clusterProps):this.points[l[a+I]])}if(c.length===0)throw new Error(n);return c}getLeaves(t,e,r){e=e||10,r=r||0;const n=[];return this._appendLeaves(n,t,e,r,0),n}getTile(t,e,r){const n=this.trees[this._limitZoom(t)],i=Math.pow(2,t),{extent:l,radius:h}=this.options,s=h/l,u=(r-s)/i,f=(r+1+s)/i,c={features:[]};return this._addTileFeatures(n.range((e-s)/i,u,(e+1+s)/i,f),n.data,e,r,i,c),e===0&&this._addTileFeatures(n.range(1-s/i,u,1,f),n.data,i,r,i,c),e===i-1&&this._addTileFeatures(n.range(0,u,s/i,f),n.data,-1,r,i,c),c.features.length?c:null}getClusterExpansionZoom(t){let e=this._getOriginZoom(t)-1;for(;e<=this.options.maxZoom;){const r=this.getChildren(t);if(e++,r.length!==1)break;t=r[0].properties.cluster_id}return e}_appendLeaves(t,e,r,n,i){const l=this.getChildren(e);for(const h of l){const s=h.properties;if(s&&s.cluster?i+s.point_count<=n?i+=s.point_count:i=this._appendLeaves(t,s.cluster_id,r,n,i):i<n?i++:t.push(h),t.length===r)break}return i}_createTree(t){const e=new et(t.length/this.stride|0,this.options.nodeSize,Float32Array);for(let r=0;r<t.length;r+=this.stride)e.add(t[r],t[r+1]);return e.finish(),e.data=t,e}_addTileFeatures(t,e,r,n,i,l){for(const h of t){const s=h*this.stride,u=e[s+L]>1;let f,c,m;if(u)f=ft(e,s,this.clusterProps),c=e[s],m=e[s+1];else{const g=this.points[e[s+I]];f=g.properties;const[x,b]=g.geometry.coordinates;c=U(x),m=N(b)}const a={type:1,geometry:[[Math.round(this.options.extent*(c*i-r)),Math.round(this.options.extent*(m*i-n))]],tags:f};let d;u||this.options.generateId?d=e[s+I]:d=this.points[e[s+I]].id,d!==void 0&&(a.id=d),l.features.push(a)}}_limitZoom(t){return Math.max(this.options.minZoom,Math.min(Math.floor(+t),this.options.maxZoom+1))}_cluster(t,e){const{radius:r,extent:n,reduce:i,minPoints:l}=this.options,h=r/(n*Math.pow(2,e)),s=t.data,u=[],f=this.stride;for(let c=0;c<s.length;c+=f){if(s[c+P]<=e)continue;s[c+P]=e;const m=s[c],a=s[c+1],d=t.within(s[c],s[c+1],h),g=s[c+L];let x=g;for(const b of d){const w=b*f;s[w+P]>e&&(x+=s[w+L])}if(x>g&&x>=l){let b=m*g,w=a*g,y,M=-1;const C=((c/f|0)<<5)+(e+1)+this.points.length;for(const j of d){const k=j*f;if(s[k+P]<=e)continue;s[k+P]=e;const _=s[k+L];b+=s[k]*_,w+=s[k+1]*_,s[k+Q]=C,i&&(y||(y=this._map(s,c,!0),M=this.clusterProps.length,this.clusterProps.push(y)),i(y,this._map(s,k)))}s[c+Q]=C,u.push(b/x,w/x,1/0,C,-1,x),i&&u.push(M)}else{for(let b=0;b<f;b++)u.push(s[c+b]);if(x>1)for(const b of d){const w=b*f;if(!(s[w+P]<=e)){s[w+P]=e;for(let y=0;y<f;y++)u.push(s[w+y])}}}}return u}_getOriginId(t){return t-this.points.length>>5}_getOriginZoom(t){return(t-this.points.length)%32}_map(t,e,r){if(t[e+L]>1){const l=this.clusterProps[t[e+dt]];return r?Object.assign({},l):l}const n=this.points[t[e+I]].properties,i=this.options.map(n);return r&&i===n?Object.assign({},i):i}}function ct(o,t,e){return{type:"Feature",id:o[t+I],properties:ft(o,t,e),geometry:{type:"Point",coordinates:[$t(o[t]),Ut(o[t+1])]}}}function ft(o,t,e){const r=o[t+L],n=r>=1e4?`${Math.round(r/1e3)}k`:r>=1e3?`${Math.round(r/100)/10}k`:r,i=o[t+dt],l=i===-1?{}:Object.assign({},e[i]);return Object.assign(l,{cluster:!0,cluster_id:o[t+I],point_count:r,point_count_abbreviated:n})}function U(o){return o/360+.5}function N(o){const t=Math.sin(o*Math.PI/180),e=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return e<0?0:e>1?1:e}function $t(o){return(o-.5)*360}function Ut(o){const t=(180-o*360)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function Nt(o,t){var e={};for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&t.indexOf(r)<0&&(e[r]=o[r]);if(o!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,r=Object.getOwnPropertySymbols(o);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(o,r[n])&&(e[r[n]]=o[r[n]]);return e}class E{static isAdvancedMarkerAvailable(t){return google.maps.marker&&t.getMapCapabilities().isAdvancedMarkersAvailable===!0}static isAdvancedMarker(t){return google.maps.marker&&t instanceof google.maps.marker.AdvancedMarkerElement}static setMap(t,e){this.isAdvancedMarker(t)?t.map=e:t.setMap(e)}static getPosition(t){if(this.isAdvancedMarker(t)){if(t.position){if(t.position instanceof google.maps.LatLng)return t.position;if(t.position.lat&&t.position.lng)return new google.maps.LatLng(t.position.lat,t.position.lng)}return new google.maps.LatLng(null)}return t.getPosition()}static getVisible(t){return this.isAdvancedMarker(t)?!0:t.getVisible()}}class q{constructor({markers:t,position:e}){this.markers=t,e&&(e instanceof google.maps.LatLng?this._position=e:this._position=new google.maps.LatLng(e))}get bounds(){if(this.markers.length===0&&!this._position)return;const t=new google.maps.LatLngBounds(this._position,this._position);for(const e of this.markers)t.extend(E.getPosition(e));return t}get position(){return this._position||this.bounds.getCenter()}get count(){return this.markers.filter(t=>E.getVisible(t)).length}push(t){this.markers.push(t)}delete(){this.marker&&(E.setMap(this.marker,null),this.marker=void 0),this.markers.length=0}}class Dt{constructor({maxZoom:t=16}){this.maxZoom=t}noop({markers:t}){return Gt(t)}}const Gt=o=>o.map(e=>new q({position:E.getPosition(e),markers:[e]}));class zt extends Dt{constructor(t){var{maxZoom:e,radius:r=60}=t,n=Nt(t,["maxZoom","radius"]);super({maxZoom:e}),this.state={zoom:-1},this.superCluster=new Ft(Object.assign({maxZoom:this.maxZoom,radius:r},n))}calculate(t){let e=!1;const r={zoom:t.map.getZoom()};if(!st(t.markers,this.markers)){e=!0,this.markers=[...t.markers];const n=this.markers.map(i=>{const l=E.getPosition(i);return{type:"Feature",geometry:{type:"Point",coordinates:[l.lng(),l.lat()]},properties:{marker:i}}});this.superCluster.load(n)}return e||(this.state.zoom<=this.maxZoom||r.zoom<=this.maxZoom)&&(e=!st(this.state,r)),this.state=r,e&&(this.clusters=this.cluster(t)),{clusters:this.clusters,changed:e}}cluster({map:t}){return this.superCluster.getClusters([-180,-90,180,90],Math.round(t.getZoom())).map(e=>this.transformCluster(e))}transformCluster({geometry:{coordinates:[t,e]},properties:r}){if(r.cluster)return new q({markers:this.superCluster.getLeaves(r.cluster_id,1/0).map(i=>i.properties.marker),position:{lat:e,lng:t}});const n=r.marker;return new q({markers:[n],position:E.getPosition(n)})}}class Vt{constructor(t,e){this.markers={sum:t.length};const r=e.map(i=>i.count),n=r.reduce((i,l)=>i+l,0);this.clusters={count:e.length,markers:{mean:n/e.length,sum:n,min:Math.min(...r),max:Math.max(...r)}}}}class Ht{render({count:t,position:e},r,n){const l=`<svg fill="${t>Math.max(10,r.clusters.markers.mean)?"#ff0000":"#0000ff"}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="50" height="50">
<circle cx="120" cy="120" opacity=".6" r="70" />
<circle cx="120" cy="120" opacity=".3" r="90" />
<circle cx="120" cy="120" opacity=".2" r="110" />
<text x="50%" y="50%" style="fill:#fff" text-anchor="middle" font-size="50" dominant-baseline="middle" font-family="roboto,arial,sans-serif">${t}</text>
</svg>`,h=`Cluster of ${t} markers`,s=Number(google.maps.Marker.MAX_ZINDEX)+t;if(E.isAdvancedMarkerAvailable(n)){const c=new DOMParser().parseFromString(l,"image/svg+xml").documentElement;c.setAttribute("transform","translate(0 25)");const m={map:n,position:e,zIndex:s,title:h,content:c};return new google.maps.marker.AdvancedMarkerElement(m)}const u={position:e,zIndex:s,title:h,icon:{url:`data:image/svg+xml;base64,${btoa(l)}`,anchor:new google.maps.Point(25,25)}};return new google.maps.Marker(u)}}function Wt(o,t){for(let e in t.prototype)o.prototype[e]=t.prototype[e]}class rt{constructor(){Wt(rt,google.maps.OverlayView)}}var F;(function(o){o.CLUSTERING_BEGIN="clusteringbegin",o.CLUSTERING_END="clusteringend",o.CLUSTER_CLICK="click"})(F||(F={}));const Kt=(o,t,e)=>{e.fitBounds(t.bounds)};class Yt extends rt{constructor({map:t,markers:e=[],algorithmOptions:r={},algorithm:n=new zt(r),renderer:i=new Ht,onClusterClick:l=Kt}){super(),this.markers=[...e],this.clusters=[],this.algorithm=n,this.renderer=i,this.onClusterClick=l,t&&this.setMap(t)}addMarker(t,e){this.markers.includes(t)||(this.markers.push(t),e||this.render())}addMarkers(t,e){t.forEach(r=>{this.addMarker(r,!0)}),e||this.render()}removeMarker(t,e){const r=this.markers.indexOf(t);return r===-1?!1:(E.setMap(t,null),this.markers.splice(r,1),e||this.render(),!0)}removeMarkers(t,e){let r=!1;return t.forEach(n=>{r=this.removeMarker(n,!0)||r}),r&&!e&&this.render(),r}clearMarkers(t){this.markers.length=0,t||this.render()}render(){const t=this.getMap();if(t instanceof google.maps.Map&&t.getProjection()){google.maps.event.trigger(this,F.CLUSTERING_BEGIN,this);const{clusters:e,changed:r}=this.algorithm.calculate({markers:this.markers,map:t,mapCanvasProjection:this.getProjection()});if(r||r==null){const n=new Set;for(const l of e)l.markers.length==1&&n.add(l.markers[0]);const i=[];for(const l of this.clusters)l.marker!=null&&(l.markers.length==1?n.has(l.marker)||E.setMap(l.marker,null):i.push(l.marker));this.clusters=e,this.renderClusters(),requestAnimationFrame(()=>i.forEach(l=>E.setMap(l,null)))}google.maps.event.trigger(this,F.CLUSTERING_END,this)}}onAdd(){this.idleListener=this.getMap().addListener("idle",this.render.bind(this)),this.render()}onRemove(){google.maps.event.removeListener(this.idleListener),this.reset()}reset(){this.markers.forEach(t=>E.setMap(t,null)),this.clusters.forEach(t=>t.delete()),this.clusters=[]}renderClusters(){const t=new Vt(this.markers,this.clusters),e=this.getMap();this.clusters.forEach(r=>{r.markers.length===1?r.marker=r.markers[0]:(r.marker=this.renderer.render(r,t,e),r.markers.forEach(n=>E.setMap(n,null)),this.onClusterClick&&r.marker.addListener("click",n=>{google.maps.event.trigger(this,F.CLUSTER_CLICK,r),this.onClusterClick(n,r,e)})),E.setMap(r.marker,e)})}}const Qt=o=>{var h,s,u,f,c;const{sensor:t,onClick:e,setMarkerRef:r,color:n}=o,i=v.useCallback(()=>e(t),[e,t]),l=v.useCallback(m=>{var a;(a=t==null?void 0:t.info)!=null&&a.id&&r(m,String(t.info.id))},[r,(h=t==null?void 0:t.info)==null?void 0:h.id]);return p.jsx(Et,{position:{lat:((s=t==null?void 0:t.info)==null?void 0:s.lat)||0,lng:((u=t==null?void 0:t.info)==null?void 0:u.lng)||0},ref:l,onClick:i,children:p.jsx(T,{sx:{width:35,height:35,borderRadius:"50%",bgcolor:n,opacity:.8,border:2,borderColor:"common.white",display:"flex",alignItems:"center",justifyContent:"center",color:"common.white",fontSize:12,fontWeight:"bold",cursor:"pointer",textShadow:"0px 0px 3px black","&:hover":{opacity:1,transform:"scale(1.1)",transition:"all 0.2s ease-in-out"}},children:((f=t==null?void 0:t.lastMeasurement)==null?void 0:f.soilMoisture)!==null?(c=t==null?void 0:t.lastMeasurement)==null?void 0:c.soilMoisture:"N/A"})})},ge=o=>{const{limite_inferior:t,limite_superior:e,capacidadIdeal:r,agua_suelo:n}=o,i=n?parseFloat(n):null;if(i===null)return"#808080";const l=t!==null?t:10,h=e!==null?e:50,s=r?parseFloat(r):null,u=(y,M,C)=>Math.max(0,Math.min(1,(y-M)/(C-M))),f=(y,M,C)=>{const j=y.replace("#",""),k=M.replace("#",""),_=parseInt(j.substr(0,2),16),S=parseInt(j.substr(2,2),16),R=parseInt(j.substr(4,2),16),D=parseInt(k.substr(0,2),16),G=parseInt(k.substr(2,2),16),z=parseInt(k.substr(4,2),16),V=Math.round(_+(D-_)*C),H=Math.round(S+(G-S)*C),W=Math.round(R+(z-R)*C);return`#${(V<<16|H<<8|W).toString(16).padStart(6,"0")}`},c="#f10b0b",m="#00ff00",a="#0b2af1",d="#ffff00";if(s!==null){if(i===s)return m;if(i>s){const M=u(i,s,h);return f(m,a,M)}const y=u(i,l,s);return f(c,m,y)}const g=h-l,x=l+g/2,b=g*.2;if(i>=x-b&&i<=x+b)return d;if(i>x){const y=u(i,x+b,h);return f(d,a,y)}const w=u(i,l,x-b);return f(c,d,w)},Jt=o=>{const{bottomLimit:t,topLimit:e,idealCapacity:r,soilMoisture:n}=o,i=n;if(i===null)return"#808080";const l=t!==null?t:10,h=e!==null?e:50,s=r,u=(y,M,C)=>Math.max(0,Math.min(1,(y-M)/(C-M))),f=(y,M,C)=>{const j=y.replace("#",""),k=M.replace("#",""),_=parseInt(j.substr(0,2),16),S=parseInt(j.substr(2,2),16),R=parseInt(j.substr(4,2),16),D=parseInt(k.substr(0,2),16),G=parseInt(k.substr(2,2),16),z=parseInt(k.substr(4,2),16),V=Math.round(_+(D-_)*C),H=Math.round(S+(G-S)*C),W=Math.round(R+(z-R)*C);return`#${(V<<16|H<<8|W).toString(16).padStart(6,"0")}`},c="#f10b0b",m="#00ff00",a="#0b2af1",d="#ffff00";if(s!==null){if(i===s)return m;if(i>s){const M=u(i,s,h);return f(m,a,M)}const y=u(i,l,s);return f(c,m,y)}const g=h-l,x=l+g/2,b=g*.2;if(i>=x-b&&i<=x+b)return d;if(i>x){const y=u(i,x+b,h);return f(d,a,y)}const w=u(i,l,x-b);return f(c,d,w)},qt=({clustersAndSensors:o})=>{const t=jt(),[e,r]=v.useState({}),[n,i]=v.useState(null),l=v.useRef([]),h=v.useMemo(()=>{if(!o)return[];const a=[];return o.forEach(d=>{var g,x;(g=d.sensor15)!=null&&g.info&&a.push(d.sensor15),(x=d.sensor30)!=null&&x.info&&a.push(d.sensor30)}),a},[o]);v.useEffect(()=>{if(!t||!(o!=null&&o.length))return;const a=new google.maps.LatLngBounds;o.forEach(d=>{var g,x;d.cluster.lat&&d.cluster.lng&&a.extend({lat:d.cluster.lat,lng:d.cluster.lng}),(x=(g=d.cluster.area)==null?void 0:g.coordinates)!=null&&x.length&&d.cluster.area.coordinates.forEach(b=>{a.extend(b)})}),h.forEach(d=>{var g;(g=d==null?void 0:d.info)!=null&&g.lat&&(d!=null&&d.info.lng)&&a.extend({lat:d.info.lat,lng:d.info.lng})}),a.isEmpty()||t.fitBounds(a,50)},[t,o,h]);const s=v.useMemo(()=>t?new Yt({map:t}):null,[t]);v.useEffect(()=>{s&&(s.clearMarkers(),s.addMarkers(Object.values(e)))},[s,e]);const u=v.useCallback((a,d)=>!a||!d||!d.length?[]:d.map(g=>{var M,C;if(!g.cluster.area||!g.cluster.area.coordinates)return null;const x=((M=g.sensor15)==null?void 0:M.info)||((C=g.sensor30)==null?void 0:C.info),b=x?"#0D8A2A":"#535353",w=x?"#4ADE80":"#B0B0B0",y=new google.maps.Polygon({paths:g.cluster.area.coordinates,strokeColor:b,strokeOpacity:.9,strokeWeight:2.5,fillColor:w,fillOpacity:.4,map:a});return y.addListener("click",()=>{var k,_;const j=new google.maps.LatLngBounds;(_=(k=g==null?void 0:g.cluster)==null?void 0:k.area)==null||_.coordinates.forEach(S=>{j.extend(S)}),a==null||a.fitBounds(j,50)}),y}).filter(Boolean),[]);v.useEffect(()=>{if(!(!t||!o))return l.current.forEach(a=>a.setMap(null)),l.current=[],l.current=u(t,o),()=>{l.current.forEach(a=>a.setMap(null))}},[t,o,u]);const f=v.useCallback((a,d)=>{r(g=>{if(a&&g[d]||!a&&!g[d])return g;if(a)return{...g,[d]:a};const{[d]:x,...b}=g;return b})},[]),c=v.useCallback(()=>{i(null)},[]),m=v.useCallback(a=>{var d;(d=a==null?void 0:a.info)!=null&&d.id&&i(a.info.id)},[]);return p.jsx(p.Fragment,{children:h.map(a=>{var g,x,b,w,y,M;if(!((g=a==null?void 0:a.info)!=null&&g.id)||!((x=a==null?void 0:a.info)!=null&&x.lng)||!((b=a==null?void 0:a.info)!=null&&b.lat))return null;const d=Jt({idealCapacity:a.info.idalCapacity,bottomLimit:a.info.bottomLimit,topLimit:a.info.topLimit,soilMoisture:((w=a==null?void 0:a.lastMeasurement)==null?void 0:w.soilMoisture)||null});return p.jsxs("div",{children:[p.jsx(Qt,{sensor:a,onClick:m,setMarkerRef:f,color:d}),n===a.info.id&&p.jsx(_t,{position:{lat:a.info.lat,lng:a.info.lng},onCloseClick:c,children:p.jsxs(T,{sx:{p:1},children:[p.jsx(O,{variant:"body1",gutterBottom:!0,children:a.info.name||a.info.deviceId}),p.jsxs(O,{variant:"body2",color:"text.secondary",children:["Humedad del suelo:"," ",((y=a==null?void 0:a.lastMeasurement)==null?void 0:y.soilMoisture)!==null?`${(M=a==null?void 0:a.lastMeasurement)==null?void 0:M.soilMoisture}%`:"N/A"]})]})})]},a.info.id)})})},Xt=({clustersAndSensors:o})=>p.jsx(Lt,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},style:{height:"100%"},children:p.jsx(qt,{clustersAndSensors:o})}),me=({isContentOnTab:o=!1,ranchId:t})=>{const{data:e,isLoading:r,isError:n,error:i}=bt({queryKey:["clusters-by-ranch",t],queryFn:()=>At(t),enabled:!!t});return r?p.jsx(Bt,{}):n?p.jsx(it,{message:i.message}):!e||e.length===0?p.jsx(it,{message:"Sin sensores asignados"}):p.jsxs(A,{container:!0,spacing:2,sx:{height:{xs:"auto",md:o?"calc(100vh - 300px)":"calc(100vh - 190px)"}},children:[p.jsx(A,{item:!0,xs:12,md:6,sx:{height:{xs:"auto",md:"100%"}},children:p.jsx(xt,{fillContent:!0,sx:{height:"100%","& .simplebar-content":{height:"100%",display:"flex",flexDirection:"column"}},children:p.jsx(T,{sx:{flexGrow:1},children:e==null?void 0:e.map(l=>p.jsx(Rt,{name:l.cluster.name,sensors:[l.sensor15,l.sensor30]},l.cluster.id))})})}),p.jsx(A,{item:!0,xs:12,md:6,sx:{height:{xs:400,md:"100%"}},children:p.jsx(tt,{elevation:3,sx:{height:"100%",borderRadius:2,overflow:"hidden"},children:p.jsx(It,{children:p.jsx(Xt,{clustersAndSensors:e})})})})]})};export{Yt as M,me as R,ge as g};
