import{g as ws,e as vs,s as $e,_ as J,r as o,f as Cs,h as Ss,i as Es,k as Is,l as le,m as ks,n as Ts,j as e,o as Ns,p as Rs,q as He,B as k,t as V,v as me,w as re,S as ce,T as M,M as Q,x as Le,d as L,I as O,L as fe,y as we,z as Ge,A as Ue,C as Xe,E as Pe,F as Ee,b as Ps,D as Ms,H as Ds}from"./index-DNJ-7_Rf.js";import{C as As}from"./config-global-CwnLHF89.js";import{u as G}from"./useQuery-Cikl35b1.js";import{u as K,S as H}from"./success-alert-D8Pc2hKc.js";import{u as We,a as _e,M as ae,A as Fs,b as zs,C as Os,c as $s}from"./index.modern-BSJ2A2Eu.js";import{L as q}from"./LoadingButton-ibHk8LjJ.js";import{z as je,E as U,S as oe}from"./index-DnZn71We.js";import{G as Ls,a as Us,b as Ws,R as de,c as _s,e as Ks,g as Bs,d as qs}from"./admin-clusters-CbYe47uX.js";import{T as W}from"./TextField-DrqQKz-z.js";import{D as Vs,a as Hs,b as Gs}from"./DialogContent-DmUc9Cb3.js";import{D as Zs}from"./DialogTitle-m1-UEW8M.js";import{F as ee,I as se,S as Y,O as ge}from"./Select-C6NYPjTS.js";import{C as xe}from"./Chip-BXj8O4Gd.js";import{C as X}from"./Card-98N49c-B.js";import{C as Ke}from"./CardHeader-BODd0mTE.js";import{C as ue}from"./CardContent-DR76uJN9.js";import{S as B}from"./Stack-BvggcJT0.js";import{T as ie}from"./Tooltip-DbXBuVyG.js";import{L as pe}from"./ListItemText-C9xeFpMB.js";import{D as Js,g as Qs,a as Ys,u as Xs,b as et}from"./admin-stations-DSwXooBP.js";import{G as Ze}from"./Grid-BaR81AYS.js";import{u as be}from"./useMediaQuery-BWWVbJPQ.js";import{u as ve,g as Fe,c as st,a as tt,b as nt,d as rt,f as at}from"./iot-Dg2SjAsq.js";import{G as ot,a as it,u as es,S as lt,b as _,g as ct,c as Me,t as dt}from"./sortable-table-cell-4A-9xpJw.js";import{A as De}from"./Autocomplete-BwuapI8N.js";import{S as ut}from"./Snackbar-Ca286brL.js";import{f as ht}from"./utils-DgT3aVHO.js";import{S as mt}from"./Slider-CXET07Dr.js";import{f as gt}from"./users-Dd3MPzKO.js";import{T as ss}from"./table-loading-DNHH0sRX.js";import{T as ts,a as ns,b as rs,c as Ae,d as A,e as as}from"./TableRow-DysWAKuU.js";import{a as Te,C as Ne}from"./tabs-CATy_744.js";import{f as xt,S as pt}from"./format-time-Ca3E0HHB.js";import{T as ft,a as Re}from"./Tabs-D274aWzn.js";import"./index-KKIBTe8w.js";import"./useControlled-CYejl48w.js";import"./CircularProgress-DypZclCl.js";import"./colorManipulator-CN4-k9CK.js";import"./Popper-yRRR-Rwr.js";import"./use-debounce-BKmKytjS.js";import"./es-AKIt1KYa.js";import"./en-US-B7LV0LqM.js";import"./KeyboardArrowRight-DgOaYwjI.js";function jt(t){return vs("MuiCollapse",t)}ws("MuiCollapse",["root","horizontal","vertical","entered","hidden","wrapper","wrapperInner"]);const bt=["addEndListener","children","className","collapsedSize","component","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","orientation","style","timeout","TransitionComponent"],yt=t=>{const{orientation:r,classes:n}=t,s={root:["root",`${r}`],entered:["entered"],hidden:["hidden"],wrapper:["wrapper",`${r}`],wrapperInner:["wrapperInner",`${r}`]};return Rs(s,jt,n)},wt=$e("div",{name:"MuiCollapse",slot:"Root",overridesResolver:(t,r)=>{const{ownerState:n}=t;return[r.root,r[n.orientation],n.state==="entered"&&r.entered,n.state==="exited"&&!n.in&&n.collapsedSize==="0px"&&r.hidden]}})(({theme:t,ownerState:r})=>J({height:0,overflow:"hidden",transition:t.transitions.create("height")},r.orientation==="horizontal"&&{height:"auto",width:0,transition:t.transitions.create("width")},r.state==="entered"&&J({height:"auto",overflow:"visible"},r.orientation==="horizontal"&&{width:"auto"}),r.state==="exited"&&!r.in&&r.collapsedSize==="0px"&&{visibility:"hidden"})),vt=$e("div",{name:"MuiCollapse",slot:"Wrapper",overridesResolver:(t,r)=>r.wrapper})(({ownerState:t})=>J({display:"flex",width:"100%"},t.orientation==="horizontal"&&{width:"auto",height:"100%"})),Ct=$e("div",{name:"MuiCollapse",slot:"WrapperInner",overridesResolver:(t,r)=>r.wrapperInner})(({ownerState:t})=>J({width:"100%"},t.orientation==="horizontal"&&{width:"auto",height:"100%"})),os=o.forwardRef(function(r,n){const s=Cs({props:r,name:"MuiCollapse"}),{addEndListener:a,children:i,className:d,collapsedSize:u="0px",component:h,easing:f,in:g,onEnter:p,onEntered:v,onEntering:w,onExit:b,onExited:T,onExiting:m,orientation:l="vertical",style:x,timeout:j=Ss.standard,TransitionComponent:C=Es}=s,I=Is(s,bt),E=J({},s,{orientation:l,collapsedSize:u}),$=yt(E),P=le(),R=ks(),N=o.useRef(null),c=o.useRef(),S=typeof u=="number"?`${u}px`:u,D=l==="horizontal",y=D?"width":"height",F=o.useRef(null),Ie=Ts(n,F),te=z=>Z=>{if(z){const ne=F.current;Z===void 0?z(ne):z(ne,Z)}},he=()=>N.current?N.current[D?"clientWidth":"clientHeight"]:0,gs=te((z,Z)=>{N.current&&D&&(N.current.style.position="absolute"),z.style[y]=S,p&&p(z,Z)}),xs=te((z,Z)=>{const ne=he();N.current&&D&&(N.current.style.position="");const{duration:ye,easing:ke}=He({style:x,timeout:j,easing:f},{mode:"enter"});if(j==="auto"){const Ve=P.transitions.getAutoHeightDuration(ne);z.style.transitionDuration=`${Ve}ms`,c.current=Ve}else z.style.transitionDuration=typeof ye=="string"?ye:`${ye}ms`;z.style[y]=`${ne}px`,z.style.transitionTimingFunction=ke,w&&w(z,Z)}),ps=te((z,Z)=>{z.style[y]="auto",v&&v(z,Z)}),fs=te(z=>{z.style[y]=`${he()}px`,b&&b(z)}),js=te(T),bs=te(z=>{const Z=he(),{duration:ne,easing:ye}=He({style:x,timeout:j,easing:f},{mode:"exit"});if(j==="auto"){const ke=P.transitions.getAutoHeightDuration(Z);z.style.transitionDuration=`${ke}ms`,c.current=ke}else z.style.transitionDuration=typeof ne=="string"?ne:`${ne}ms`;z.style[y]=S,z.style.transitionTimingFunction=ye,m&&m(z)}),ys=z=>{j==="auto"&&R.start(c.current||0,z),a&&a(F.current,z)};return e.jsx(C,J({in:g,onEnter:gs,onEntered:ps,onEntering:xs,onExit:fs,onExited:js,onExiting:bs,addEndListener:ys,nodeRef:F,timeout:j==="auto"?null:j},I,{children:(z,Z)=>e.jsx(wt,J({as:h,className:Ns($.root,d,{entered:$.entered,exited:!g&&S==="0px"&&$.hidden}[z]),style:J({[D?"minWidth":"minHeight"]:S},x),ref:Ie},Z,{ownerState:J({},E,{state:z}),children:e.jsx(vt,{ownerState:J({},E,{state:z}),className:$.wrapper,ref:N,children:e.jsx(Ct,{ownerState:J({},E,{state:z}),className:$.wrapperInner,children:i})})}))}))});os.muiSupportAuto=!0;function ze(){const t=We(),r=_e("drawing"),[n,s]=o.useState(null),[a,i]=o.useState([]),[d,u]=o.useState([]),[h,f]=o.useState(null),[g,p]=o.useState(null),v=o.useCallback(()=>{const x=d.map(j=>{const C=j.getPath(),I=[];return C.forEach(E=>{I.push({lat:E.lat(),lng:E.lng()})}),I});i(x)},[d]),w=o.useCallback(x=>{if(!t)return;h&&h.setMap(null);const j=new google.maps.Marker({position:x,map:t});f(j),p(x)},[t,h]);o.useEffect(()=>{if(!t||!r)return;const x=new r.DrawingManager({map:t,drawingMode:null,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.POLYGON]},polygonOptions:{editable:!1,draggable:!1},markerOptions:{draggable:!0}});return google.maps.event.addListener(x,"overlaycomplete",j=>{if(j.type===google.maps.drawing.OverlayType.POLYGON){const C=j.overlay;u(I=>[...I,C]),["set_at","insert_at","remove_at"].forEach(I=>{google.maps.event.addListener(C.getPath(),I,v)}),v()}else if(j.type===google.maps.drawing.OverlayType.MARKER){const C=j.overlay,I=C.getPosition();if(h&&h.setMap(null),I){const E={lat:I.lat(),lng:I.lng()};p(E)}f(C),google.maps.event.addListener(C,"dragend",()=>{const E=C.getPosition();E&&p({lat:E.lat(),lng:E.lng()})})}x.setDrawingMode(null)}),s(x),()=>{x&&(x.setMap(null),google.maps.event.clearListeners(x,"overlaycomplete")),d.forEach(j=>{["set_at","insert_at","remove_at"].forEach(C=>{google.maps.event.clearListeners(j.getPath(),C)})}),h&&(h.setMap(null),google.maps.event.clearInstanceListeners(h))}},[t,r,v,h,d]),o.useEffect(()=>{d.length>0&&v()},[d,v]);const b=o.useCallback(x=>{if(!t)return;const j=[];x.forEach(C=>{const I=new google.maps.Polygon({paths:C,map:t,editable:!0,draggable:!0});["set_at","insert_at","remove_at"].forEach(E=>{google.maps.event.addListener(I.getPath(),E,v)}),j.push(I)}),u(C=>[...C,...j])},[t,v]),T=o.useCallback(x=>{x<0||x>=d.length||(d[x].setMap(null),["set_at","insert_at","remove_at"].forEach(j=>{google.maps.event.clearListeners(d[x].getPath(),j)}),u(j=>j.filter((C,I)=>I!==x)))},[d]),m=o.useCallback(()=>{d.forEach(x=>{x.setMap(null),["set_at","insert_at","remove_at"].forEach(j=>{google.maps.event.clearListeners(x.getPath(),j)})}),u([]),i([])},[d]),l=o.useCallback(()=>{h&&(h.setMap(null),google.maps.event.clearInstanceListeners(h),f(null),p(null))},[h]);return{drawingManager:n,polygons:d,polygonsCoordinates:a,markerPosition:g,currentMarker:h,setMarkerFromCoordinates:w,removePolygon:T,clearAllPolygons:m,clearMarker:l,addMultiplePolygonsFromCoordinates:b}}const St=({onSendFunction:t,isLoading:r})=>{const{polygonsCoordinates:n,markerPosition:s}=ze();return e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderRadius:1,overflow:"clip"},children:e.jsx(ae,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!1,controlSize:25,style:{height:500}})}),e.jsx(q,{variant:"contained",fullWidth:!0,sx:{mb:2,mt:1},onClick:()=>{t(s,n)},loading:r,disabled:r,children:"Crear rancho"})]})},Oe=async()=>{try{const t=await fetch(`${V}/api/rancho/with-sensores`);if(!t.ok)throw new Error("Network response was not ok");const n=(await t.json()).map(s=>{try{return{...s,area:s.area?JSON.parse(s.area):null}}catch(a){return console.error("Failed to parse area for item:",s,a),{...s,area:null}}});return Ls.parse(n)}catch(t){throw t instanceof je.ZodError?(console.error("Validation error:",t.errors),new Error(t.message)):new Error(t)}},Et=async()=>{try{const t=await fetch(`${V}/api/rancho/unassigned-sensores`);if(!t.ok)throw new Error("Network response was not ok");const r=await t.json();return Us.parse(r)}catch(t){throw t instanceof je.ZodError?(console.error("Validation error:",t.errors),new Error(t.message)):new Error(t)}},Ce=async(t,r)=>{try{const n=await fetch(`${V}/api/rancho/assign-sensor`,{method:"POST",body:JSON.stringify({rancho_id:r,sensor_id:t}),headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error("Network response was not ok");if((await n.json()).message!=="Sensor asignado al rancho exitosamente.")throw new Error("Ha ocurrido un error al asignar el sensor")}catch(n){throw new Error(`Failed to move sensor to Ranch: ${n}`)}},It=async t=>{try{const r=await fetch(`${V}/api/rancho/unassign-sensores`,{method:"PUT",body:JSON.stringify({sensor_ids:[t]}),headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error("Network response was not ok");if((await r.json()).message!=="Sensores desasignados exitosamente.")throw new Error("Ha ocurrido un error al asignar el sensor")}catch(r){throw new Error(`Failed to move sensor to Ranch: ${r}`)}},is=async(t,r,n,s)=>{try{const a=await fetch(`${V}/api/rancho/create`,{method:"POST",body:JSON.stringify({nombre:t,lat:r,long:n,area:{tipo:"polígono",coordenadas:s}}),headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error("Network response was not ok");if((await a.json()).message!=="Rancho creado exitosamente")throw new Error("Ha ocurrido un error al asignar el sensor")}catch(a){throw new Error(`Failed to move sensor to Ranch: ${a}`)}},ls=async(t,r,n,s,a)=>{try{const i=await fetch(`${V}/api/rancho/update/${a}`,{method:"PUT",body:JSON.stringify({nombre:t,lat:r,long:n,area:{tipo:"polígono",coordenadas:s}}),headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error("Network response was not ok");if((await i.json()).message!=="Rancho actualizado exitosamente.")throw new Error("Ha ocurrido un error al asignar el sensor")}catch(i){throw new Error(`Failed to move sensor to Ranch: ${i}`)}},cs=async(t,r)=>{try{const n=r.map(async s=>{const a=await fetch(`${V}/api/rancho/assign-user`,{method:"POST",body:JSON.stringify({user_id:s,rancho_id:t}),headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error(`Failed to assign ranch to user ${s}`);const i=await a.json();if(i.message!=="Rancho asignado al usuario exitosamente.")throw new Error(`Error assigning ranch to user ${s}: ${i.message}`);return i});await Promise.all(n)}catch(n){throw n instanceof je.ZodError?(console.error("Validation error:",n.errors),new Error(n.message)):n}},ds=async t=>{if(!t)throw new Error("No ranch id found.");try{const r=await fetch(`${V}/api/rancho/${t}/usuarios`);if(!r.ok)throw new Error("Network response was not ok");const n=await r.json();if(n.message!=="Usuarios recuperados exitosamente")throw new Error("No se pudieron recuperar los usuarios");return Ws.parse(n)}catch(r){throw new Error(`Failed to move sensor to Ranch: ${r}`)}},us=async(t,r)=>{try{const n=r.map(async s=>{const a=await fetch(`${V}/api/rancho/unassign-user`,{method:"DELETE",body:JSON.stringify({user_id:s,rancho_id:t}),headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error(`Failed to assign ranch to user ${s}`);const i=await a.json();if(i.message!=="La asignación del rancho al usuario se eliminó exitosamente.")throw new Error(`Error assigning ranch to user ${s}: ${i.message}`);return i});await Promise.all(n)}catch(n){throw n instanceof je.ZodError?(console.error("Validation error:",n.errors),new Error(n.message)):n}},kt=({refetchRanchesWithSensors:t})=>{const[r,n]=o.useState(!1),[s,a]=o.useState(""),i=K({mutationKey:["createNewRanch",r],mutationFn:({ranchName:u,lat:h,long:f,areaCoordinates:g})=>is(u,h,f,g),onSuccess:()=>{t(),a("")}}),d=(u,h)=>{!u||h.length===0||!s||i.mutate({ranchName:s,lat:u.lat,long:u.lng,areaCoordinates:h})};return e.jsxs(e.Fragment,{children:[e.jsx(me,{variant:"contained",color:"inherit",size:"small",onClick:()=>n(!0),children:"Crear Rancho"}),e.jsx(re,{open:r,onClose:()=>n(!1),anchor:"right",sx:{height:"100vh"},children:e.jsx(ce,{children:e.jsxs(k,{sx:{width:{xs:300,sm:500,md:600},p:{xs:1.5,sm:4}},children:[e.jsx(M,{variant:"subtitle1",children:"Crear un nuevo rancho"}),e.jsx(W,{fullWidth:!0,size:"small",label:"Nombre",sx:{mt:2},value:s,onChange:u=>a(u.target.value)}),e.jsx(M,{variant:"caption",sx:{mt:3,mb:1,display:"block"},children:"Selecciona la ubicación del rancho y el su área"}),e.jsx(de,{children:e.jsx(St,{isLoading:i.isPending,onSendFunction:d})}),i.isError&&e.jsx(U,{message:`${i.error}`}),i.isSuccess&&e.jsx(H,{message:"Rancho creado"})]})})})]})},Tt=({ranchId:t,refetch:r,onCloseDrawer:n})=>{const[s,a]=o.useState(!1),i=K({mutationFn:async()=>{const d=await fetch(`${V}/api/rancho/delete/${t}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!d.ok)throw new Error("Error al eliminar el rancho");return d.json()},onSuccess:d=>{d.message==="Rancho eliminado exitosamente."&&(r(),a(!1),n())}});return e.jsxs(e.Fragment,{children:[e.jsx(me,{variant:"contained",color:"error",onClick:()=>a(!0),sx:{mb:4,width:"100%"},children:"Eliminar Rancho"}),e.jsxs(Vs,{open:s,onClose:()=>a(!1),children:[e.jsx(Zs,{children:"¿Estás seguro de eliminar este rancho?"}),e.jsx(Hs,{children:"Esta acción no se puede deshacer."}),e.jsxs(Gs,{children:[e.jsx(me,{onClick:()=>a(!1),color:"primary",children:"Cancelar"}),e.jsx(me,{onClick:()=>i.mutate(),color:"error",disabled:i.isPending,children:i.isPending?"Eliminando...":"Eliminar"})]})]})]})},Nt=({onSendFunction:t,isLoading:r,marker:n,polygon:s})=>{const{markerPosition:a,polygonsCoordinates:i,setMarkerFromCoordinates:d,addMultiplePolygonsFromCoordinates:u}=ze();return o.useEffect(()=>{n&&d(n)},[n]),o.useEffect(()=>{s&&i.length===0&&u(s)},[s]),e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderRadius:1,overflow:"clip"},children:e.jsx(ae,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!1,controlSize:25,style:{height:500}})}),e.jsx(q,{variant:"contained",fullWidth:!0,sx:{mb:2,mt:1},onClick:()=>{t(a,i)},loading:r,disabled:r,children:"Actualizar Rancho"})]})},Rt=({refetchRanchesWithSensors:t,isOpen:r,onCloseDrawer:n,ranch:s})=>{var $,P;const[a,i]=o.useState([]),[d,u]=o.useState([]),[h,f]=o.useState(""),[g,p]=o.useState(null),[v,w]=o.useState(null),{data:b,refetch:T}=G({queryKey:["get-users-in-ranches",s.id],queryFn:()=>ds(s.id),enabled:!!s.id}),m=K({mutationKey:["update-ranch",s.id],mutationFn:({ranchName:R,lat:N,long:c,areaCoordinates:S,ranchId:D})=>ls(R,N,c,S,D),onSuccess:()=>{t()}}),l=K({mutationKey:["assignToUser",s.id],mutationFn:({ranchId:R,ids:N})=>cs(R,N),onSuccess:()=>{i([]),u([]),T()}}),x=K({mutationKey:["assignToUser",s.id],mutationFn:({ranchId:R,ids:N})=>us(R,N),onSuccess:()=>{i([]),u([]),T()}});o.useEffect(()=>{var R,N;if(f(s.name||""),i([]),u([]),s.lat&&s.long&&w({lat:s.lat,lng:s.long}),s.area&&((N=(R=s==null?void 0:s.area)==null?void 0:R.coordinates)==null?void 0:N.length)>=1){const c=s.area.coordinates;Array.isArray(c[0])?p(c):typeof c[0]=="object"&&c[0]!==null?p([c]):(console.error("Unexpected coordinates format"),p([]))}else p([])},[s]);const j=(R,N)=>{if(R&&N.length>0&&h&&m.mutate({ranchName:h,lat:R.lat,long:R.lng,areaCoordinates:N,ranchId:s.id,userIds:a}),a&&a.length>0){const c=a.map(Number);l.mutate({ranchId:s.id,ids:c})}if(d&&d.length>0){const c=d.map(Number);x.mutate({ranchId:s.id,ids:c})}},C=()=>{i([]),n()},I=R=>{const{target:{value:N}}=R;i(typeof N=="string"?N.split(","):N)},E=R=>{const{target:{value:N}}=R;u(typeof N=="string"?N.split(","):N)};return e.jsx(re,{open:r,onClose:C,anchor:"right",sx:{height:"100vh"},children:e.jsx(ce,{children:e.jsxs(k,{sx:{width:{xs:300,sm:500,md:600},p:{xs:1.5,sm:4},height:"100vh"},children:[e.jsx(M,{variant:"subtitle1",children:"Editar un rancho"}),e.jsx(W,{fullWidth:!0,size:"small",label:"Nombre",sx:{mt:2},value:h,onChange:R=>f(R.target.value)}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"assign-to-users",children:"Assignar usuarios"}),e.jsx(Y,{labelId:"assign-to-users",id:"assign-to-users",multiple:!0,value:a,onChange:I,input:e.jsx(ge,{label:"Assignar a usuarios"}),size:"small",renderValue:R=>e.jsx(k,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:R.map(N=>{var S;const c=(S=b==null?void 0:b.data.notAssigned)==null?void 0:S.find(D=>D.id.toString()===N);return e.jsx(xe,{label:(c==null?void 0:c.name)||N,size:"small"},N)})}),children:($=b==null?void 0:b.data.notAssigned)==null?void 0:$.map(R=>e.jsx(Q,{value:R.id.toString(),children:R.name},R.id))})]}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"assign-to-users",children:"Remover usuarios"}),e.jsx(Y,{labelId:"assign-to-users",id:"assign-to-users",multiple:!0,value:d,onChange:E,input:e.jsx(ge,{label:"Assignar a usuarios"}),size:"small",renderValue:R=>e.jsx(k,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:d.map(N=>{var S;const c=(S=b==null?void 0:b.data.assigned)==null?void 0:S.find(D=>D.id.toString()===N);return e.jsx(xe,{label:(c==null?void 0:c.name)||N,size:"small"},N)})}),children:(P=b==null?void 0:b.data.assigned)==null?void 0:P.map(R=>e.jsx(Q,{value:R.id.toString(),children:R.name},R.id))})]}),e.jsx(M,{variant:"caption",sx:{mt:3,mb:1,display:"block"},children:"Selecciona la ubicación del rancho y el su área"}),e.jsx(de,{children:e.jsx(Nt,{onSendFunction:j,isLoading:m.isPending,marker:v,polygon:g})}),e.jsx(Tt,{onCloseDrawer:C,ranchId:s.id,refetch:t}),m.isError&&e.jsx(U,{message:`${m.error}`}),l.isError&&e.jsx(U,{message:`${l.error}`}),x.isError&&e.jsx(U,{message:`${l.error}`}),m.isSuccess&&e.jsx(H,{message:"Rancho actualizado"}),l.isSuccess&&e.jsx(H,{message:"Usuarios asignados"}),x.isSuccess&&e.jsx(H,{message:"Usuarios removidos"})]})})})},Pt=({ranch:t,setSelectedRanch:r,refetchRanchesWithSensors:n,refetchSensorsWithoutRanches:s,setIsDrawerOpen:a})=>{const{sensors:i,...d}=t,u=K({mutationFn:({sensorId:g})=>It(g),onSuccess:()=>{n(),s()}}),h=Le(),f=i.sort((g,p)=>g.name?p.name?g.name.localeCompare(p.name,void 0,{numeric:!0}):-1:1);return e.jsxs(X,{sx:{height:"100%"},children:[e.jsx(Ke,{title:t.name||"Sin nombre",action:e.jsx(L,{onClick:()=>{r(d),a(!0)},children:e.jsx(O,{icon:"solar:pen-bold-duotone"})})}),e.jsxs(ue,{children:[f.length===0&&e.jsxs(B,{direction:"column",justifyContent:"center",alignItems:"center",gap:1,mt:2,children:[e.jsx(O,{icon:"duo-icons:chip",width:25}),e.jsx(M,{variant:"caption",children:"Sin sensores"})]}),e.jsx(fe,{children:f.map(g=>e.jsx(we,{secondaryAction:e.jsx(ie,{title:"Quitar del rancho",children:e.jsx(L,{edge:"end","aria-label":"delete",onClick:()=>u.mutate({sensorId:g.id}),children:e.jsx(O,{width:24,icon:"solar:remove-folder-bold-duotone"})})}),children:e.jsx(pe,{onClick:()=>h(`/iot/sensor/${g.deviceId}`),primary:g.name||"Sin nombre",secondary:g.deviceId,sx:{cursor:"pointer"}})},g.id))})]})]})},Mt=({sensors:t,setSensorToAssign:r,setIsAssignSensorDrawerOpen:n})=>{const s=Le(),a=t.sort((i,d)=>i.name?d.name?i.name.localeCompare(d.name,void 0,{numeric:!0}):-1:1);return e.jsxs(X,{children:[e.jsx(Ke,{title:"Sensores sin rancho"}),e.jsx(ue,{children:e.jsx(fe,{children:a.map(i=>e.jsx(we,{secondaryAction:e.jsx(ie,{title:"Mover a un rancho",children:e.jsx(L,{edge:"end","aria-label":"delete",onClick:()=>{r({id:i.id,name:i.name||i.deviceId}),n(!0)},children:e.jsx(O,{width:24,icon:"solar:move-to-folder-bold-duotone"})})}),children:e.jsx(pe,{onClick:()=>s(`/iot/sensor/${i.deviceId}`),primary:i.name||"Sin nombre",secondary:i.deviceId,sx:{cursor:"pointer"}})},i.id))})})]})},Dt=({selectedSensor:t,isAssignSensorDrawerOpen:r,onCloseDrawer:n,ranchesWithIdAndName:s,refetchRanchesWithSensors:a,refetchSensorsWithoutRanches:i})=>{const[d,u]=o.useState(""),h=K({mutationKey:["assign-sensor-to-ranch",t.id],mutationFn:({sensorId:g,ranchToBeMovedId:p})=>Ce(g,p),onSuccess:()=>{u(""),a(),i()}}),f=g=>{u(g.target.value)};return e.jsx(re,{open:r,onClose:n,anchor:"right",sx:{height:"100vh"},children:e.jsxs(k,{sx:{width:{xs:300,sm:500},p:{xs:1.5,sm:4},height:"100vh"},children:[e.jsxs(M,{variant:"subtitle1",children:["Mover el sensor ",t.name]}),e.jsx(M,{variant:"caption",sx:{mb:2,mt:1},children:"Selecionar un rancho al que deseas mover el sensor"}),e.jsx(Y,{sx:{mb:1,mt:2},fullWidth:!0,size:"small",value:d,onChange:f,children:s==null?void 0:s.map(g=>e.jsx(Q,{value:g.ranchId,children:g.ranchName},g.ranchId))}),e.jsx(q,{variant:"contained",fullWidth:!0,sx:{mb:2},onClick:()=>{d&&h.mutate({sensorId:t.id,ranchToBeMovedId:Number(d)})},disabled:h.isPending,loading:h.isPending,children:"Mover sensor"}),h.isError&&e.jsx(U,{message:`${h.error}`}),h.isSuccess&&e.jsx(H,{message:"Sensor asignado correctamente"})]})})},At=()=>{const[t,r]=o.useState(!1),[n,s]=o.useState(null),a=()=>{r(!1),s(null)},[i,d]=o.useState(!1),[u,h]=o.useState(null),f=()=>{d(!1),s(null)},{data:g,isLoading:p,isError:v,error:w,refetch:b}=G({queryKey:["all-ranches-with-sensors"],queryFn:Oe}),{data:T,isLoading:m,isError:l,error:x,refetch:j}=G({queryKey:["all-sensors-without-ranches"],queryFn:Et});if(p||m)return e.jsx(Js,{});if(v||l)return e.jsx(U,{message:`${w==null?void 0:w.message}. ${x==null?void 0:x.message}`});if(!g||!T)return null;const C=g.map(I=>({ranchId:I.id,ranchName:I.name}));return e.jsxs(e.Fragment,{children:[e.jsxs(B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(M,{variant:"subtitle1",mt:3,children:"Ranchos"}),e.jsx(kt,{refetchRanchesWithSensors:b})]}),e.jsx(Ze,{container:!0,spacing:2,mt:1,children:g==null?void 0:g.map(I=>e.jsx(Ze,{item:!0,xs:12,sm:6,lg:4,children:e.jsx(Pt,{ranch:I,setSelectedRanch:h,setIsDrawerOpen:d,refetchRanchesWithSensors:b,refetchSensorsWithoutRanches:j})},I.id))}),e.jsx(M,{variant:"subtitle1",mt:7,mb:3,children:"Sensors sin ranchos asignados"}),e.jsx(Mt,{sensors:T,setIsAssignSensorDrawerOpen:r,setSensorToAssign:s}),n!=null&&n.id||n!=null&&n.name?e.jsx(Dt,{selectedSensor:n,isAssignSensorDrawerOpen:t,onCloseDrawer:a,ranchesWithIdAndName:C,refetchRanchesWithSensors:b,refetchSensorsWithoutRanches:j}):null,u?e.jsx(Rt,{ranch:u,refetchRanchesWithSensors:b,isOpen:i,onCloseDrawer:f}):null]})},Be=({children:t})=>{const r=le(),n=be(r.breakpoints.down("sm"));return e.jsx(k,{sx:{width:"100%",height:"100%",borderRight:n?0:1,borderLeft:n?0:1,borderColor:"divider",display:"flex",flexDirection:"column"},children:t})},Je=({onBack:t,showBackButton:r,selectedCluster:n})=>{var a,i;const s=(n==null?void 0:n.sensor15)||(n==null?void 0:n.sensor30);return e.jsxs(Be,{children:[e.jsxs(k,{sx:{p:2,borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",flexWrap:"wrap",height:65},children:[r&&e.jsx(L,{onClick:t,edge:"start",sx:{mr:1},children:e.jsx(O,{icon:"solar:arrow-left-line-duotone"})}),e.jsx(M,{variant:"h6",component:"div",children:"Sensores"})]}),n?s?e.jsxs(fe,{sx:{flexGrow:1,overflow:"auto"},children:[((a=n.sensor15)==null?void 0:a.info)&&e.jsx(we,{children:e.jsx(Ge,{to:`/iot/sensor/${n.sensor15.info.deviceId}`,style:{textDecoration:"none",color:"inherit"},children:e.jsx(pe,{primary:n.sensor15.info.name||"Sin nombre",secondary:n.sensor15.info.deviceId})})}),((i=n.sensor30)==null?void 0:i.info)&&e.jsx(we,{children:e.jsx(Ge,{to:`/iot/sensor/${n.sensor30.info.deviceId}`,style:{textDecoration:"none",color:"inherit"},children:e.jsx(pe,{primary:n.sensor30.info.name||"Sin nombre",secondary:n.sensor30.info.deviceId})})})]}):e.jsx(k,{sx:{p:2,textAlign:"center"},children:e.jsx(M,{variant:"body1",color:"text.secondary",children:"Sin sensores por mostrar"})}):null]})},Ft=({onSendFunction:t,isLoading:r,isMobile:n})=>{const{polygonsCoordinates:s,markerPosition:a}=ze();return e.jsxs(k,{children:[e.jsx(k,{sx:{borderRadius:1,overflow:"clip"},children:e.jsx(ae,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!1,controlSize:25,style:{height:500}})}),e.jsx(q,{variant:"contained",onClick:()=>{t(a,s)},loading:r,disabled:r,fullWidth:!0,sx:{width:n?"100%":"fit-content",display:"flex",justifyContent:"center",marginTop:n?2:0,position:n?"relative":"absolute",top:n?"auto":26,right:n?"auto":32},children:"Crear cluster"})]})},zt=({refetchRanchesWithSensors:t})=>{const[r,n]=o.useState(!1),[s,a]=o.useState(""),i=le(),d=be(i.breakpoints.down("sm")),u=K({mutationKey:["createNewRanch",r],mutationFn:({ranchName:f,lat:g,long:p,areaCoordinates:v})=>is(f,g,p,v),onSuccess:()=>{t(),a("")}}),h=(f,g)=>{!f||g.length===0||!s||u.mutate({ranchName:s,lat:f.lat,long:f.lng,areaCoordinates:g})};return e.jsxs(e.Fragment,{children:[e.jsx(me,{variant:"contained",color:"inherit",size:"small",sx:{mt:d?1:0,ml:"auto"},onClick:()=>n(!0),children:"Crear Rancho"}),e.jsx(re,{open:r,onClose:()=>n(!1),anchor:"right",sx:{height:"100vh"},children:e.jsx(ce,{children:e.jsxs(k,{sx:{width:{xs:300,sm:500,md:600},p:{xs:1.5,sm:4}},children:[e.jsx(M,{variant:"subtitle1",children:"Crear un nuevo rancho"}),u.isError&&e.jsx(k,{sx:{my:2},children:e.jsx(U,{message:`${u.error}`})}),u.isSuccess&&e.jsx(k,{sx:{my:2},children:e.jsx(H,{message:"Rancho creado"})}),e.jsx(W,{fullWidth:!0,size:"small",label:"Nombre",sx:{mt:2},value:s,onChange:f=>a(f.target.value)}),e.jsx(M,{variant:"caption",sx:{mt:3,mb:1,display:"block"},children:"Selecciona la ubicación del rancho y el su área"}),e.jsx(de,{children:e.jsx(Ft,{isLoading:u.isPending,onSendFunction:h,isMobile:d})})]})})})]})},Ot=({onSendFunction:t,isLoading:r,marker:n,polygon:s,isMobile:a})=>{const{markerPosition:i,polygonsCoordinates:d,setMarkerFromCoordinates:u,addMultiplePolygonsFromCoordinates:h}=ze();return o.useEffect(()=>{n&&u(n)},[n]),o.useEffect(()=>{s&&h(s)},[s]),e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderRadius:1,overflow:"clip"},children:e.jsx(ae,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!1,controlSize:25,style:{height:500}})}),e.jsx(q,{variant:"contained",fullWidth:!0,sx:{width:a?"100%":"fit-content",display:"flex",justifyContent:"center",marginTop:a?2:0,position:a?"relative":"absolute",top:a?"auto":26,right:a?"auto":32},onClick:()=>{t(i,d)},loading:r,disabled:r,children:"Actualizar Rancho"})]})},$t=({refetchRanchesWithSensors:t,isOpen:r,onCloseDrawer:n,ranch:s})=>{var R,N;const[a,i]=o.useState([]),[d,u]=o.useState([]),[h,f]=o.useState(""),[g,p]=o.useState(null),[v,w]=o.useState(null),b=le(),T=be(b.breakpoints.down("sm")),{data:m,refetch:l}=G({queryKey:["get-users-in-ranches",s.id],queryFn:()=>ds(s.id),enabled:!!s.id}),x=K({mutationKey:["update-ranch",s.id],mutationFn:({ranchName:c,lat:S,long:D,areaCoordinates:y,ranchId:F})=>ls(c,S,D,y,F),onSuccess:()=>{t()}}),j=K({mutationKey:["assignToUser",s.id],mutationFn:({ranchId:c,ids:S})=>cs(c,S),onSuccess:()=>{i([]),u([]),l()}}),C=K({mutationKey:["assignToUser",s.id],mutationFn:({ranchId:c,ids:S})=>us(c,S),onSuccess:()=>{i([]),u([]),l()}});o.useEffect(()=>{var c,S;if(f(s.name||""),i([]),u([]),s.lat&&s.long&&w({lat:s.lat,lng:s.long}),s.area&&((S=(c=s==null?void 0:s.area)==null?void 0:c.coordinates)==null?void 0:S.length)>=1){const D=s.area.coordinates;Array.isArray(D[0])?p(D):typeof D[0]=="object"&&D[0]!==null?p([D]):(console.error("Unexpected coordinates format"),p([]))}else p([])},[s]);const I=(c,S)=>{if(c&&S.length>0&&h&&x.mutate({ranchName:h,lat:c.lat,long:c.lng,areaCoordinates:S,ranchId:s.id,userIds:a}),a&&a.length>0){const D=a.map(Number);j.mutate({ranchId:s.id,ids:D})}if(d&&d.length>0){const D=d.map(Number);C.mutate({ranchId:s.id,ids:D})}},E=()=>{i([]),n()},$=c=>{const{target:{value:S}}=c;i(typeof S=="string"?S.split(","):S)},P=c=>{const{target:{value:S}}=c;u(typeof S=="string"?S.split(","):S)};return e.jsx(re,{open:r,onClose:E,anchor:"right",sx:{height:"100vh"},children:e.jsx(ce,{children:e.jsxs(k,{sx:{width:{xs:300,sm:500,md:600},p:{xs:1.5,sm:4},height:"100vh"},children:[e.jsx(M,{variant:"subtitle1",children:"Editar un rancho"}),x.isError&&e.jsx(k,{sx:{my:2},children:e.jsx(U,{message:`${x.error}`})}),j.isError&&e.jsx(k,{sx:{my:2},children:e.jsx(U,{message:`${j.error}`})}),C.isError&&e.jsx(k,{sx:{my:2},children:e.jsx(U,{message:`${j.error}`})}),x.isSuccess&&e.jsx(k,{sx:{my:2},children:e.jsx(H,{message:"Rancho actualizado"})}),j.isSuccess&&e.jsx(k,{sx:{my:2},children:e.jsx(H,{message:"Usuarios asignados"})}),C.isSuccess&&e.jsx(k,{sx:{my:2},children:e.jsx(H,{message:"Usuarios removidos"})}),e.jsx(W,{fullWidth:!0,size:"small",label:"Nombre",sx:{mt:2},value:h,onChange:c=>f(c.target.value)}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"assign-to-users",children:"Assignar usuarios"}),e.jsx(Y,{labelId:"assign-to-users",id:"assign-to-users",multiple:!0,value:a,onChange:$,input:e.jsx(ge,{label:"Assignar a usuarios"}),size:"small",renderValue:c=>e.jsx(k,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:c.map(S=>{var y;const D=(y=m==null?void 0:m.data.notAssigned)==null?void 0:y.find(F=>F.id.toString()===S);return e.jsx(xe,{label:(D==null?void 0:D.name)||S,size:"small"},S)})}),children:(R=m==null?void 0:m.data.notAssigned)==null?void 0:R.map(c=>e.jsx(Q,{value:c.id.toString(),children:c.name},c.id))})]}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"assign-to-users",children:"Remover usuarios"}),e.jsx(Y,{labelId:"assign-to-users",id:"assign-to-users",multiple:!0,value:d,onChange:P,input:e.jsx(ge,{label:"Assignar a usuarios"}),size:"small",renderValue:c=>e.jsx(k,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:d.map(S=>{var y;const D=(y=m==null?void 0:m.data.assigned)==null?void 0:y.find(F=>F.id.toString()===S);return e.jsx(xe,{label:(D==null?void 0:D.name)||S,size:"small"},S)})}),children:(N=m==null?void 0:m.data.assigned)==null?void 0:N.map(c=>e.jsx(Q,{value:c.id.toString(),children:c.name},c.id))})]}),e.jsx(M,{variant:"caption",sx:{mt:3,mb:1,display:"block"},children:"Selecciona la ubicación del rancho y el su área"}),e.jsx(de,{children:e.jsx(Ot,{onSendFunction:I,isLoading:x.isPending,marker:v,polygon:g,isMobile:T})})]})})})},hs=()=>e.jsxs(B,{direction:"column",spacing:1,children:[e.jsx(oe,{variant:"rectangular",height:50}),e.jsx(oe,{variant:"rectangular",height:50}),e.jsx(oe,{variant:"rectangular",height:50}),e.jsx(oe,{variant:"rectangular",height:50}),e.jsx(oe,{variant:"rectangular",height:50}),e.jsx(oe,{variant:"rectangular",height:50}),e.jsx(oe,{variant:"rectangular",height:50})]}),Qe=({onItemClick:t,selectedRanch:r})=>{const[n,s]=o.useState(!1),[a,i]=o.useState(null),d=()=>{s(!1),i(null)},{data:u,refetch:h,isLoading:f,isError:g,error:p}=G({queryKey:["all-ranches-with-sensors"],queryFn:Oe});return e.jsxs(e.Fragment,{children:[e.jsxs(Be,{children:[e.jsxs(k,{sx:{p:2,borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",flexWrap:"wrap",height:65},children:[e.jsx(M,{variant:"h6",component:"div",children:"Ranchos"}),e.jsx(zt,{refetchRanchesWithSensors:h})]}),g&&e.jsx(U,{message:String(p)}),f&&e.jsx(hs,{}),e.jsx(fe,{sx:{flexGrow:1,overflow:"auto"},children:u==null?void 0:u.map(v=>e.jsxs(Ue,{onClick:()=>t(v),sx:{backgroundColor:r&&r.id===v.id?"rgba(0, 0, 0, 0.04)":"none"},children:[e.jsx(pe,{primary:v.name}),e.jsx(Xe,{children:e.jsx(L,{edge:"end","aria-label":"edit",onClick:w=>{w.stopPropagation(),i(v),s(!0)},children:e.jsx(O,{icon:"solar:pen-bold-duotone"})})})]},v.id))})]}),a?e.jsx($t,{ranch:a,refetchRanchesWithSensors:h,isOpen:n,onCloseDrawer:d}):null]})};function qe(t=null){const r=We(),n=_e("drawing"),[s,a]=o.useState(t),[i,d]=o.useState(null),[u,h]=o.useState(null),[f,g]=o.useState([]),[p,v]=o.useState(null),w=o.useCallback(m=>{const l=m.getPath(),x=[];l.forEach(j=>{x.push({lat:j.lat(),lng:j.lng()})}),g(x)},[]),b=o.useCallback(m=>{if(!r)return;i&&i.setMap(null);const l=new google.maps.Marker({position:m,map:r});d(l),h(m)},[r,i]),T=o.useCallback(m=>{if(!r)return;p&&p.setMap(null);const l=new google.maps.Polygon({paths:m,map:r,editable:!0,draggable:!0});google.maps.event.addListener(l.getPath(),"set_at",()=>{w(l)}),google.maps.event.addListener(l.getPath(),"insert_at",()=>{w(l)}),google.maps.event.addListener(l.getPath(),"remove_at",()=>{w(l)}),v(l),g(m)},[r,p,w]);return o.useEffect(()=>{if(!r||!n)return;const m=new n.DrawingManager({map:r,drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.POLYGON]},polygonOptions:{editable:!0,draggable:!0}}),l=x=>{if(x.type===google.maps.drawing.OverlayType.MARKER){const j=x.overlay,C=j.getPosition();if(i&&i.setMap(null),C){const I={lat:C.lat(),lng:C.lng()};h(I)}d(j)}else if(x.type===google.maps.drawing.OverlayType.POLYGON){const j=x.overlay;p&&p.setMap(null),v(j),w(j),google.maps.event.addListener(j.getPath(),"set_at",()=>{w(j)}),google.maps.event.addListener(j.getPath(),"insert_at",()=>{w(j)}),google.maps.event.addListener(j.getPath(),"remove_at",()=>{w(j)})}m.setDrawingMode(null)};return google.maps.event.addListener(m,"overlaycomplete",l),a(m),()=>{m.setMap(null),google.maps.event.clearListeners(m,"overlaycomplete")}},[r,n,i,p,w]),{drawingManager:s,markerPosition:u,polygonCoordinates:f,currentMarker:i,currentPolygon:p,setMarkerFromCoordinates:b,setPolygonFromCoordinates:T}}const Lt=({onSendFunction:t,isLoading:r,isMobile:n})=>{const{markerPosition:s,polygonCoordinates:a}=qe();return e.jsxs(k,{children:[e.jsx(k,{sx:{borderRadius:1,overflow:"clip"},children:e.jsx(ae,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!1,controlSize:25,style:{height:500}})}),e.jsx(q,{variant:"contained",onClick:()=>{t(s,a)},loading:r,disabled:r,fullWidth:!0,sx:{width:n?"100%":"fit-content",display:"flex",justifyContent:"center",marginTop:n?2:0,position:n?"relative":"absolute",top:n?"auto":26,right:n?"auto":32},children:"Crear cluster"})]})},Se=async(t,r)=>{if(!t||!r.length)throw new Error("Missing Data");try{const n=await fetch(`${V}/api/sensors/sensores/${t}/coordenadas`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({coordenadas:r})});if(!n.ok)throw new Error(`Request failed with status code ${n.status}`);return!0}catch{return!1}},Ut=async()=>{try{const t=await fetch(`${V}/api/sensors/ultima-medicion-unica`);if(!t.ok)throw new Error("Network response was not ok");const r=await t.json();return ot.parse(r)}catch(t){throw t instanceof je.ZodError?(console.error("Validation error:",t.errors),new Error(t.message)):new Error(t)}},ms=async()=>{try{const t=await fetch(`${V}/api/sensores`);if(!t.ok)throw new Error("Network response was not ok");const r=await t.json();return it.parse(r)}catch(t){throw t instanceof je.ZodError?(console.error("Validation error:",t.errors),new Error(t.message)):new Error(t)}},Wt=({refetchClusters:t})=>{const[r,n]=o.useState(!1),[s,a]=o.useState(""),[i,d]=o.useState(""),[u,h]=o.useState("#4F46E5"),[f,g]=o.useState(""),[p,v]=o.useState(null),[w,b]=o.useState(null),[T,m]=o.useState(!1),[l,x]=o.useState(""),j=le(),C=be(j.breakpoints.down("sm")),{data:I}=G({queryKey:["all-ranches-with-sensors"],queryFn:Oe}),{data:E}=G({queryKey:["admin-sensors"],queryFn:ms}),$=K({mutationKey:["createNewRanch",r],mutationFn:c=>_s({name:c.clusterName,lat:c.lat,long:c.long,coordinatesArea:c.areaCoordinates,type:c.clusterType,color:c.clusterColor,sensor30ID:c.sensor30cmId,sensor15ID:c.sensor15cmId,ranchoId:c.ranchId}),onSuccess:()=>{t(),a(""),d(""),h("#4F46E5"),g(""),v(null),b(null)}}),P=(c,S)=>{S!=="clickaway"&&m(!1)},R=(c,S)=>s?f?i?!c||S.length===0?(x("Ubicación o area no ingresada"),m(!0),!1):!0:(x("Tipo no ingresado"),m(!0),!1):(x("Rancho no seleccionado"),m(!0),!1):(x("Nombre no ingresado"),m(!0),!1),N=async(c,S)=>{R(c,S)&&($.mutate({clusterName:s,clusterType:i,clusterColor:u,lat:c.lat,long:c.lng,areaCoordinates:S,ranchId:Number(f),sensor15cmId:p?Number(p.id):null,sensor30cmId:w?Number(w.id):null}),p!=null&&p.deviceId&&(await ve(p==null?void 0:p.deviceId,c.lat,c.lng),await Se(p.deviceId,S),await Ce(p==null?void 0:p.id,Number(f))),w!=null&&w.deviceId&&(await ve(w==null?void 0:w.deviceId,c.lat,c.lng),await Se(w.deviceId,S),await Ce(w==null?void 0:w.id,Number(f))))};return!E||!I?null:e.jsxs(e.Fragment,{children:[e.jsx(me,{variant:"contained",color:"inherit",size:"small",sx:{mt:C?1:0,ml:"auto"},onClick:()=>n(!0),children:"Crear cluster"}),e.jsx(re,{open:r,onClose:()=>n(!1),anchor:"right",sx:{height:"100vh"},children:e.jsx(ce,{children:e.jsxs(k,{sx:{width:{xs:300,sm:500,md:600},p:{xs:1.5,sm:4}},children:[e.jsx(M,{variant:"subtitle1",children:"Crear un nuevo cluster"}),$.isError&&e.jsx(k,{sx:{my:2},children:e.jsx(U,{message:`${$.error}`})}),$.isSuccess&&e.jsx(k,{sx:{my:2},children:e.jsx(H,{message:"Cluster creado"})}),e.jsx(W,{fullWidth:!0,size:"small",label:"Nombre",sx:{mt:2},value:s,onChange:c=>a(c.target.value)}),e.jsxs(ee,{fullWidth:!0,size:"small",sx:{mt:2},children:[e.jsx(se,{children:"Rancho"}),e.jsx(Y,{value:f,label:"Rancho",onChange:c=>g(c.target.value),children:I==null?void 0:I.map(c=>e.jsx(Q,{value:c.id,children:c.name},c.id))})]}),e.jsx(De,{size:"small",options:E,sx:{mt:2},value:p,onChange:(c,S)=>v(S),getOptionLabel:c=>c.name?c.name:`S/N - ${c.deviceId}`,getOptionDisabled:c=>(w==null?void 0:w.id)===c.id,isOptionEqualToValue:(c,S)=>c.id===S.id,renderInput:c=>e.jsx(W,{...c,label:"Sensor a 15 cm"})}),e.jsx(De,{size:"small",options:E,sx:{mt:2},value:w,onChange:(c,S)=>b(S),getOptionLabel:c=>c.name?c.name:`S/N - ${c.deviceId}`,getOptionDisabled:c=>(p==null?void 0:p.id)===c.id,isOptionEqualToValue:(c,S)=>c.id===S.id,renderInput:c=>e.jsx(W,{...c,label:"Sensor a 30 cm"})}),e.jsx(W,{fullWidth:!0,size:"small",label:"Tipo",sx:{mt:2},value:i,onChange:c=>d(c.target.value),placeholder:"Ingrese el tipo de cluster"}),e.jsx(W,{type:"color",size:"small",label:"Color",fullWidth:!0,value:u,onChange:c=>h(c.target.value),sx:{mt:2,'& input[type="color"]':{width:"100%",padding:1}}}),e.jsx(M,{variant:"caption",sx:{mt:3,mb:1,display:"block"},children:"Selecciona la ubicación del rancho y el su área"}),e.jsx(de,{children:e.jsx(Lt,{isLoading:$.isPending,onSendFunction:N,isMobile:C})})]})})}),e.jsx(ut,{open:T,autoHideDuration:6e3,onClose:P,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(Pe,{onClose:P,severity:"error",sx:{width:"100%"},children:l})})]})},_t=({onSendFunction:t,isLoading:r,marker:n,polygon:s,isMobile:a})=>{const{markerPosition:i,polygonCoordinates:d,setMarkerFromCoordinates:u,setPolygonFromCoordinates:h}=qe();return o.useEffect(()=>{n&&u(n)},[n]),o.useEffect(()=>{s&&h(s)},[s]),e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderRadius:1,overflow:"clip"},children:e.jsx(ae,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!1,controlSize:25,style:{height:500}})}),e.jsx(q,{variant:"contained",fullWidth:!0,sx:{width:a?"100%":"fit-content",display:"flex",justifyContent:"center",marginTop:a?2:0,position:a?"relative":"absolute",top:a?"auto":26,right:a?"auto":32},onClick:()=>{t(i,d)},loading:r,disabled:r,children:"Actualizar cluster"})]})},Kt=({refetchClusters:t,isOpen:r,onCloseDrawer:n,cluster:s,onItemClick:a,selectedCluster:i})=>{var D;const[d,u]=o.useState(""),[h,f]=o.useState(""),[g,p]=o.useState("#4F46E5"),[v,w]=o.useState(""),[b,T]=o.useState(null),[m,l]=o.useState(null),[x,j]=o.useState(null),[C,I]=o.useState(null),E=le(),$=be(E.breakpoints.down("sm"));o.useEffect(()=>{var y,F,Ie,te,he;u(s.cluster.name||""),f(((y=s==null?void 0:s.cluster)==null?void 0:y.type)||""),p(((F=s==null?void 0:s.cluster)==null?void 0:F.color)||"#4F46E5"),w(String((Ie=s==null?void 0:s.cluster)==null?void 0:Ie.ranchId)||""),s.cluster.lat&&s.cluster.lng&&I({lat:s.cluster.lat,lng:s.cluster.lng}),s.cluster.area&&s.cluster.area.coordinates&&j(s.cluster.area.coordinates),(te=s.sensor15)!=null&&te.info&&T({deviceId:s.sensor15.info.deviceId,id:s.sensor15.info.id,name:s.sensor15.info.name}),(he=s.sensor30)!=null&&he.info&&l({deviceId:s.sensor30.info.deviceId,id:s.sensor30.info.id,name:s.sensor30.info.name})},[s]);const{data:P}=G({queryKey:["all-ranches-with-sensors"],queryFn:Oe}),{data:R}=G({queryKey:["admin-sensors"],queryFn:ms}),N=K({mutationKey:["update-cluster",s.cluster.id],mutationFn:y=>Ks({name:y.clusterName,lat:y.lat,long:y.long,coordinatesArea:y.areaCoordinates,type:y.clusterType,color:y.clusterColor,sensor30ID:y.sensor30cmId,sensor15ID:y.sensor15cmId,ranchoId:y.ranchId,clusterId:y.clusterId}),onSuccess:async()=>{t(),a(null)}}),c=async(y,F)=>{!y||F.length===0||!d||!h||!v||(N.mutate({clusterName:d,clusterType:h,clusterColor:g,lat:y.lat,long:y.lng,areaCoordinates:F,ranchId:Number(v),sensor15cmId:b?Number(b.id):null,sensor30cmId:m?Number(m.id):null,clusterId:s.cluster.id}),b!=null&&b.deviceId&&(await ve(b==null?void 0:b.deviceId,y.lat,y.lng),await Se(b.deviceId,F),await Ce(b==null?void 0:b.id,Number(v))),m!=null&&m.deviceId&&(await ve(m==null?void 0:m.deviceId,y.lat,y.lng),await Se(m.deviceId,F),await Ce(m==null?void 0:m.id,Number(v))))};if(!R||!P)return null;const S=(R==null?void 0:R.map(y=>({deviceId:y.deviceId,id:y.id,name:y.name})))||[];return e.jsx(re,{open:r,onClose:n,anchor:"right",sx:{height:"100vh"},children:e.jsx(ce,{children:e.jsxs(k,{sx:{width:{xs:300,sm:500,md:600},p:{xs:1.5,sm:4},height:"100vh"},children:[e.jsxs(M,{variant:"subtitle1",children:["Editar cluster ",(D=s==null?void 0:s.cluster)==null?void 0:D.name]}),N.isError&&e.jsx(k,{sx:{my:2},children:e.jsx(U,{message:`${N.error}`})}),N.isSuccess&&e.jsx(k,{sx:{my:2},children:e.jsx(H,{message:"Cluster actualizado"})}),e.jsx(W,{fullWidth:!0,size:"small",label:"Nombre",sx:{mt:2},value:d,onChange:y=>u(y.target.value)}),e.jsxs(ee,{fullWidth:!0,size:"small",sx:{mt:2},children:[e.jsx(se,{children:"Rancho"}),e.jsx(Y,{value:v,label:"Rancho",onChange:y=>w(y.target.value),children:P==null?void 0:P.map(y=>e.jsx(Q,{value:y.id,children:y.name},y.id))})]}),e.jsx(De,{size:"small",options:[{id:-1,deviceId:"",name:"Ninguno"},...S],sx:{mt:2},value:b,onChange:(y,F)=>T((F==null?void 0:F.id)===-1?null:F),getOptionLabel:y=>!y||y.id===-1?"Ninguno":y.name||`S/N - ${y.deviceId}`,getOptionDisabled:y=>(m==null?void 0:m.id)===y.id,isOptionEqualToValue:(y,F)=>y.id===F.id,renderInput:y=>e.jsx(W,{...y,label:"Sensor a 15 cm"})}),e.jsx(De,{size:"small",options:[{id:-1,deviceId:"",name:"Ninguno"},...S],sx:{mt:2},value:m,onChange:(y,F)=>l((F==null?void 0:F.id)===-1?null:F),getOptionLabel:y=>y?y.id===-1?"Ninguno":y.name||`S/N - ${y.deviceId}`:"Ninguno",getOptionDisabled:y=>(b==null?void 0:b.id)===y.id,isOptionEqualToValue:(y,F)=>y.id===F.id,renderInput:y=>e.jsx(W,{...y,label:"Sensor a 30 cm"})}),e.jsx(W,{fullWidth:!0,size:"small",label:"Tipo",sx:{mt:2},value:h,onChange:y=>f(y.target.value),placeholder:"Ingrese el tipo de cluster"}),e.jsx(W,{type:"color",size:"small",label:"Color",fullWidth:!0,value:g,onChange:y=>p(y.target.value),sx:{mt:2,'& input[type="color"]':{width:"100%",padding:1}}}),e.jsx(M,{variant:"caption",sx:{mt:3,mb:1,display:"block"},children:"Selecciona la ubicación del cluster y el su área"}),e.jsx(de,{children:e.jsx(_t,{onSendFunction:c,isLoading:N.isPending,marker:C,polygon:x,isMobile:$})})]})})})},Ye=({onBack:t,showBackButton:r,onItemClick:n,selectedRanch:s,selectedCluster:a})=>{const[i,d]=o.useState(null),[u,h]=o.useState(!1),f=()=>{h(!1),d(null)},{data:g,refetch:p,isError:v,error:w,isLoading:b}=G({queryKey:["clusters-by-ranch",s==null?void 0:s.id],queryFn:()=>s!=null&&s.id?Bs(s==null?void 0:s.id):[],enabled:!!(s!=null&&s.id)}),T=K({mutationFn:l=>qs(l.clusterTodeleteId),onSuccess:async(l,x)=>{p(),(a==null?void 0:a.cluster.id)===x.clusterTodeleteId&&n(null)}}),m=async()=>{const{data:l}=await p(),x=l==null?void 0:l.find(j=>j.cluster.id===(a==null?void 0:a.cluster.id));x&&n(x)};return e.jsxs(e.Fragment,{children:[e.jsxs(Be,{children:[e.jsxs(k,{sx:{p:2,borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",flexWrap:"wrap",height:65},children:[r&&e.jsx(L,{onClick:t,edge:"start",sx:{mr:1},children:e.jsx(O,{icon:"solar:arrow-left-line-duotone"})}),e.jsx(M,{variant:"h6",component:"div",children:"Clusters"}),e.jsx(Wt,{refetchClusters:p})]}),v&&e.jsx(U,{message:String(w)}),!v&&b&&e.jsx(hs,{}),!v&&e.jsx(fe,{sx:{flexGrow:1,overflow:"auto"},children:g==null?void 0:g.map(l=>e.jsxs(Ue,{onClick:()=>n(l),sx:{backgroundColor:a&&a.cluster.id===l.cluster.id?"rgba(0, 0, 0, 0.04)":"none"},children:[e.jsx(pe,{primary:l.cluster.name}),e.jsxs(Xe,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(L,{edge:"end","aria-label":"delete",onClick:x=>{x.stopPropagation(),T.mutate({clusterTodeleteId:l.cluster.id})},disabled:T.isPending,children:e.jsx(O,{icon:"solar:trash-bin-2-bold-duotone"})}),e.jsx(L,{edge:"end","aria-label":"edit",onClick:x=>{x.stopPropagation(),d(l),h(!0)},children:e.jsx(O,{icon:"solar:pen-bold-duotone"})})]})]},l.cluster.id))})]}),i?e.jsx(Kt,{selectedCluster:a,onItemClick:n,refetchClusters:m,isOpen:u,onCloseDrawer:f,cluster:i}):null]})},Bt=()=>{const[t,r]=o.useState(null),[n,s]=o.useState(null),[a,i]=o.useState("ranchos"),d=le(),u=be(d.breakpoints.down("sm")),h=p=>{r(p),s(null),u&&i("clusters")},f=p=>{s(p),u&&i("sensors")},g=()=>{a==="sensors"?(i("clusters"),s(null)):a==="clusters"&&(i("ranchos"),r(null))};if(u)switch(a){case"ranchos":return e.jsx(Qe,{onItemClick:h,selectedRanch:t});case"clusters":return e.jsx(Ye,{selectedCluster:n,selectedRanch:t,onItemClick:f,showBackButton:u,onBack:g});case"sensors":return e.jsx(Je,{selectedCluster:n,showBackButton:u,onBack:g});default:return null}return e.jsxs(k,{sx:{display:"flex",height:"100vh",overflow:"hidden"},children:[e.jsx(Qe,{onItemClick:h,selectedRanch:t}),e.jsx(Ye,{selectedCluster:n,selectedRanch:t,onItemClick:f,showBackButton:u,onBack:g}),e.jsx(Je,{selectedCluster:n,showBackButton:u,onBack:g})]})},qt={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},Vt=({isOpen:t,handleClose:r,refetchDevices:n,selectedSensorId:s})=>{const[a,i]=o.useState("idle"),[d,u]=o.useState(""),[h,f]=o.useState(""),[g,p]=o.useState("");o.useEffect(()=>{(async()=>{const b=await Fe(s);b&&(u(b.nombre||""),f(b.nombre||"Sin nombre"),p(b.device_id))})()},[s]);const v=async()=>{if(!(!d||!s))try{if(i("loading"),!await st(s,d)){i("error");return}i("success"),n(),u(""),r()}catch{i("error")}};return e.jsx(Ee,{open:t,onClose:r,"aria-labelledby":"child-modal-title","aria-describedby":"child-modal-description",children:e.jsx(X,{sx:{...qt,width:{xs:"90%",sm:400,md:500,lg:600}},children:e.jsxs(ue,{children:[e.jsxs(B,{direction:"row",justifyContent:"space-between",alignContent:"center",alignItems:"center",children:[e.jsxs(k,{children:[e.jsx(M,{variant:"h6",children:h}),e.jsx(M,{variant:"body2",children:g})]}),e.jsx(L,{onClick:r,children:e.jsx(O,{icon:"eva:close-fill"})})]}),e.jsx(W,{fullWidth:!0,size:"small",label:"nombre",variant:"outlined",sx:{mt:1},value:d,onChange:w=>u(w.target.value)}),e.jsx(q,{fullWidth:!0,variant:"outlined",onClick:v,sx:{mt:1},loading:a==="loading",children:"Cambiar nombre"})]})})})},Ht=({deviceId:t})=>{const{polygonCoordinates:r}=qe(),n=K({mutationFn:s=>Se(s.deviceId,s.coordinates)});return e.jsxs(e.Fragment,{children:[e.jsx(k,{sx:{borderRadius:1,overflow:"clip"},children:e.jsx(ae,{streetViewControl:!1,defaultZoom:5,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",zoomControl:!1,style:{height:400}})}),n.isSuccess?e.jsx(Pe,{severity:"success",icon:e.jsx(O,{icon:"solar:check-read-line-duotone"}),sx:{mt:1},children:"Área asignada correctamente"}):null,n.isError?e.jsx(Pe,{severity:"error",icon:e.jsx(O,{icon:"solar:shield-warning-bold-duotone"}),sx:{mt:1},children:n.error.message}):null,e.jsx(q,{variant:"contained",disabled:n.isPending,loading:n.isPending,fullWidth:!0,sx:{mt:1},onClick:()=>n.mutate({deviceId:t,coordinates:r}),children:"Asignar area"})]})},Gt={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},Zt=({deviceId:t,isOpen:r,handleClose:n})=>e.jsx(Ee,{open:r,onClose:n,"aria-labelledby":"child-modal-title","aria-describedby":"child-modal-description",children:e.jsxs(X,{sx:{...Gt,width:{xs:"90%",sm:400,md:600,lg:800}},children:[e.jsx(Ke,{title:"Área del sensor",subheader:"Asigna un área al sensor",action:e.jsx(L,{onClick:n,"aria-label":"cerrar",children:e.jsx(O,{icon:"solar:close-circle-linear",width:32,height:32})})}),e.jsx(ue,{children:e.jsx(de,{children:e.jsx(Ht,{deviceId:t})})})]})}),Jt={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},Qt=({isOpen:t,handleClose:r,selectedSensorId:n})=>{const[s,a]=o.useState(null),[i,d]=o.useState(null),[u,h]=o.useState(!1),[f,g]=o.useState([0,100]),[p,v]=o.useState("");o.useEffect(()=>{(async()=>{const l=await Fe(n);l&&(g([l.limite_inferior?l.limite_inferior:0,l.limite_superior?l.limite_superior:100]),v(l.capacidadIdeal||""))})()},[n]);const w=(m,l)=>{g(l)},b=()=>{a(null),d(null),h(!1),g([0,100]),v(""),r()},T=async()=>{if(!p||f[0]>=f[1]){d("Por favor, complete todos los campos correctamente");return}h(!0);try{const m=await fetch(`${V}/api/sensors/sensores/${n}/limites`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({limite_inferior:f[0],limite_superior:f[1]})});if(await tt(n,Number(p))&&m.ok)a("Datos del sensor actualizados exitosamente"),setTimeout(b,2e3);else throw new Error("Error en la actualización")}catch{d("Error al actualizar los datos del sensor"),setTimeout(()=>d(null),2e3)}finally{h(!1)}};return e.jsx(Ee,{open:t,onClose:b,"aria-labelledby":"change-limits-modal",children:e.jsxs(X,{sx:{...Jt,width:"90%",maxWidth:"500px"},children:[e.jsxs(B,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(M,{variant:"h6",children:"Establecer Datos del Sensor"}),e.jsx(L,{onClick:b,children:e.jsx(O,{icon:"eva:close-fill"})})]}),e.jsx(k,{component:"form",children:e.jsxs(B,{spacing:4,sx:{mt:2},children:[e.jsxs(B,{spacing:2,children:[e.jsx(M,{children:"Límites Inferior y Superior"}),e.jsx(mt,{value:f,onChange:w,valueLabelDisplay:"on",min:0,max:100}),e.jsxs(B,{direction:"row",spacing:2,children:[e.jsx(W,{label:"Límite Inferior",value:f[0],InputLabelProps:{shrink:!0},onChange:m=>{const l=Number(m.target.value);(l||l===0)&&g([l,f[1]])},type:"number",fullWidth:!0,required:!0}),e.jsx(W,{label:"Límite Superior",value:f[1],InputLabelProps:{shrink:!0},onChange:m=>{const l=Number(m.target.value);(l||l===0)&&g([f[0],l])},type:"number",fullWidth:!0,required:!0})]})]}),e.jsx(W,{fullWidth:!0,label:"Capacidad Ideal",variant:"outlined",value:p,onChange:m=>v(m.target.value),type:"number",required:!0}),s&&e.jsx(M,{variant:"body1",color:"success.main",children:s}),i&&e.jsx(M,{variant:"body1",color:"error.main",children:i}),e.jsx(q,{variant:"contained",fullWidth:!0,onClick:T,loading:u,children:"Guardar Cambios"})]})})]})})},Yt={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},Xt=({isOpen:t,handleClose:r,refetchAssignedSensors:n,selectedSensorId:s,alreadyAssignedIds:a})=>{const[i,d]=o.useState([]),[u,h]=o.useState([]),[f,g]=o.useState([]),[p,v]=o.useState("idle"),[w,b]=o.useState(null),[T,m]=o.useState();o.useEffect(()=>{(async()=>{const I=await Fe(s);I&&m(I)})()},[s]),o.useEffect(()=>{h([]),g([])},[s]),o.useEffect(()=>{(async()=>{const I=await gt();d(I)})()},[]);const l=(C,I)=>{b({message:C,type:I}),setTimeout(()=>b(null),3e3)},x=async()=>{if(!(!u.length||!s))try{v("loading"),await Promise.all(u.map(async C=>{await nt(s,Number(C))})),v("success"),n(),h([]),l("Sensores asignados correctamente.","success")}catch{v("error"),l("Error al asignar sensores. Por favor, inténtelo de nuevo.","error")}},j=async()=>{if(!(!f.length||!s))try{v("loading"),await Promise.all(f.map(async C=>{await rt(s,Number(C))})),v("success"),n(),g([]),l("Sensores removidos correctamente.","success")}catch{v("error"),l("Error al remover sensores. Por favor, inténtelo de nuevo.","error")}};return e.jsx(Ee,{open:t,onClose:r,"aria-labelledby":"manage-sensor-modal-title","aria-describedby":"manage-sensor-modal-description",children:e.jsx(X,{sx:{...Yt,width:{xs:"90%",sm:400,md:500,lg:600}},children:e.jsxs(ue,{children:[e.jsxs(B,{direction:"row",justifyContent:"space-between",alignContent:"center",alignItems:"center",children:[e.jsxs(k,{children:[e.jsx(M,{variant:"h6",children:(T==null?void 0:T.nombre)||"Sin nombre"}),e.jsx(M,{variant:"body2",children:T==null?void 0:T.device_id})]}),e.jsx(L,{onClick:r,children:e.jsx(O,{icon:"eva:close-fill"})})]}),e.jsx(os,{in:!!w,children:e.jsx(Pe,{severity:w==null?void 0:w.type,sx:{mt:2},onClose:()=>b(null),children:w==null?void 0:w.message})}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"assign-user",size:"small",children:"Asignar a Usuarios"}),e.jsx(Y,{labelId:"assign-user",id:"assign-user",label:"Asignar a Usuarios",size:"small",multiple:!0,value:u,onChange:C=>h(C.target.value),children:i.map(C=>a.includes(C.id)?null:e.jsx(Q,{value:C.id.toString(),children:C.nombre},C.id))})]}),e.jsx(q,{fullWidth:!0,variant:"contained",onClick:x,sx:{mt:1},loading:p==="loading",children:"Asignar Sensores"}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"unassign-user",size:"small",children:"Remover de Usuarios"}),e.jsx(Y,{labelId:"unassign-user",id:"unassign-user",label:"Remover de Usuarios",size:"small",multiple:!0,value:f,onChange:C=>g(C.target.value),children:i.map(C=>a.includes(C.id)?e.jsx(Q,{value:C.id.toString(),children:C.nombre},C.id):null)})]}),e.jsx(q,{fullWidth:!0,variant:"contained",color:"error",onClick:j,sx:{mt:1},loading:p==="loading",children:"Remover Sensores"})]})})})},en=({onPlaceSelect:t})=>{const r=We(),n=_e("places"),[s,a]=o.useState(),[i,d]=o.useState(null),[u,h]=o.useState(null),[f,g]=o.useState([]),[p,v]=o.useState("");o.useEffect(()=>{if(!(!n||!r))return d(new n.AutocompleteService),h(new n.PlacesService(r)),a(new n.AutocompleteSessionToken),()=>d(null)},[r,n]);const w=o.useCallback(async m=>{if(!i||!m){g([]);return}const l={input:m,sessionToken:s},x=await i.getPlacePredictions(l);g(x.predictions)},[i,s]),b=o.useCallback(m=>{var x;const l=(x=m.target)==null?void 0:x.value;v(l),w(l)},[w]),T=o.useCallback(m=>{if(!n)return;const l={placeId:m,fields:["geometry","name","formatted_address"],sessionToken:s},x=j=>{t(j),g([]),v((j==null?void 0:j.formatted_address)??""),a(new n.AutocompleteSessionToken)};u==null||u.getDetails(l,x)},[t,n,u,s]);return e.jsxs(k,{className:"autocomplete-container",sx:{mt:{xs:8,sm:1}},children:[e.jsx(X,{sx:{borderRadius:1,width:{xs:"14rem",sm:"20rem",md:"25rem"}},children:e.jsx(W,{value:p,onInput:m=>b(m),placeholder:"Search for a place",fullWidth:!0,size:"small",type:"text"})}),f.length>0&&e.jsx(X,{sx:{position:"absolute",width:"100%",zIndex:10,mt:1},children:e.jsx(ue,{children:e.jsx(fe,{children:f.map(({place_id:m,description:l})=>e.jsx(we,{disablePadding:!0,onClick:()=>T(m),children:e.jsx(Ue,{children:l})},m))})})})]})},sn={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,boxShadow:24,pt:2,px:4,pb:3},tn=({isOpen:t,handleClose:r,selectedSensorId:n})=>{const[s,a]=o.useState(null),[i,d]=o.useState(null),[u,h]=o.useState(!1),[f,g]=o.useState({latitude:null,longitude:null});o.useEffect(()=>{(async()=>{const T=await Fe(n);T&&g({latitude:T.lat?Number(T.lat):null,longitude:T.long?Number(T.long):null})})()},[n]);const p=()=>{a(null),d(null),h(!1),g({latitude:null,longitude:null}),r()},v=async()=>{if(!f.latitude||!f.longitude)return;if(h(!0),await ve(n,f.latitude,f.longitude)){a("Coordinates updated successfully"),h(!1),setTimeout(()=>a(null),2e3);return}d("Failed to update coordinates"),h(!1),setTimeout(()=>d(null),2e3)},w=b=>{var T;if((T=b==null?void 0:b.geometry)!=null&&T.location){const m=b.geometry.location.lat(),l=b.geometry.location.lng();g({latitude:m,longitude:l})}};return e.jsx(Ee,{open:t,onClose:p,"aria-labelledby":"child-modal-title","aria-describedby":"child-modal-description",children:e.jsxs(X,{sx:{...sn,width:"90%"},children:[e.jsxs(B,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(M,{variant:"h6",children:"Assignar coordenadas al sensor"}),e.jsx(L,{onClick:r,children:e.jsx(O,{icon:"eva:close-fill"})})]}),e.jsxs(ue,{children:[e.jsx(Fs,{apiKey:"AIzaSyB_LTdB65XirnWx_f6IrloEw0_Gc70L0ps",children:e.jsx(k,{height:"70vh",mt:2,children:e.jsxs(ae,{defaultZoom:5,streetViewControl:!1,defaultCenter:{lat:23.6345,lng:-102.5528},mapTypeId:"satellite",gestureHandling:"greedy",mapId:"f1b7b1b3b1b3b1b3",onClick:b=>{var l,x;const T=(l=b.detail.latLng)==null?void 0:l.lat,m=(x=b.detail.latLng)==null?void 0:x.lng;!T||!m||g({latitude:T,longitude:m})},children:[e.jsx(zs,{position:Os.TOP_CENTER,children:e.jsx(en,{onPlaceSelect:w})}),f.latitude&&f.longitude&&e.jsx($s,{position:{lat:f.latitude,lng:f.longitude}})]})})}),s&&e.jsx(M,{variant:"body1",color:"green",children:s}),i&&e.jsx(M,{variant:"body1",color:"red",children:i}),e.jsx(q,{variant:"contained",sx:{mt:1},fullWidth:!0,onClick:v,loading:u,children:"Update Sensor Coordinates"})]})]})})},nn=()=>{const{data:t,refetch:r,isLoading:n,isError:s,error:a}=G({queryKey:["admin-sensors"],queryFn:Ut,refetchInterval:6e4}),{sortedData:i,requestSort:d,getSortDirection:u,validationErrors:h,setSearchQuery:f}=es(t,dt,{defaultSort:{key:"deviceName",direction:"asc"},defaultSearchKeys:["deviceId","deviceName"]}),[g,p]=o.useState(null),[v,w]=o.useState(""),b=Le(),[T,m]=o.useState([]),[l,x]=o.useState([]),j=()=>{w(""),p(null)},C=o.useCallback(async()=>{const E=await at();m(E)},[]);o.useEffect(()=>{C()},[C]),o.useEffect(()=>{if(!v)return;const $=T.filter(P=>P.sensor_id===v).map(P=>P.user_id);x($)},[v,T]);const I=(E,$,P)=>{E.stopPropagation(),w($),p(P)};return h?e.jsx(U,{message:"Validation Errors"}):n?e.jsx(ss,{}):s?e.jsx(U,{message:a.message}):e.jsxs(X,{children:[e.jsx(k,{sx:{p:1},children:e.jsx(lt,{onSearch:f})}),e.jsx(ts,{sx:{mt:2},children:e.jsxs(ns,{children:[e.jsx(rs,{children:e.jsxs(Ae,{children:[e.jsx(A,{children:"ID"}),e.jsx(A,{children:"Status"}),e.jsx(A,{children:"Acciones"}),e.jsx(A,{children:"ID del Dispositivo"}),e.jsx(_,{getSortDirection:u,requestSort:d,sortKey:"deviceName",children:"Nombre del Dispositivo"}),e.jsx(_,{getSortDirection:u,requestSort:d,sortKey:"soilWater",children:"Humedad del Suelo"}),e.jsx(_,{getSortDirection:u,requestSort:d,sortKey:"soilConductivity",children:"Conductividad del Suelo"}),e.jsx(_,{getSortDirection:u,requestSort:d,sortKey:"soilTemperature",children:"Temperatura del Suelo"}),e.jsx(_,{getSortDirection:u,requestSort:d,sortKey:"battery",children:"Batería"}),e.jsx(_,{getSortDirection:u,requestSort:d,sortKey:"timestamp",children:"Última Actualización"})]})}),e.jsx(as,{children:i==null?void 0:i.map((E,$)=>e.jsxs(Ae,{sx:{cursor:"pointer","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"},backgroundColor:$%2===0?"rgba(255,255,255)":"rgba(250,250,250)"},onClick:()=>b(`/iot/sensor/${E.deviceId}`),children:[e.jsx(A,{children:$+1}),e.jsx(A,{children:e.jsx("div",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:ct(E.timestamp),margin:"0 auto"}})}),e.jsx(A,{children:e.jsxs(B,{spacing:1,alignItems:"center",children:[e.jsxs(B,{direction:"row",spacing:1,alignItems:"center",justifyContent:"center",children:[e.jsx(ie,{title:"Asignar a usuarios",children:e.jsx(L,{edge:"end","aria-label":"assign users",onClick:P=>I(P,E.deviceId,2),children:e.jsx(O,{width:24,icon:"solar:move-to-folder-bold"})})}),e.jsx(ie,{title:"Cambiar nombre",children:e.jsx(L,{edge:"end","aria-label":"change name",onClick:P=>I(P,E.deviceId,3),children:e.jsx(O,{width:24,icon:"solar:password-minimalistic-input-bold"})})})]}),e.jsxs(B,{direction:"row",spacing:1,alignItems:"center",justifyContent:"center",children:[e.jsx(ie,{title:"Asignar límites",children:e.jsx(L,{edge:"end","aria-label":"assign limits",onClick:P=>I(P,E.deviceId,1),children:e.jsx(O,{width:24,icon:"solar:align-vertical-center-bold"})})}),e.jsx(ie,{title:"Asignar coordenadas",children:e.jsx(L,{edge:"end","aria-label":"assign coordinates",onClick:P=>I(P,E.deviceId,0),children:e.jsx(O,{width:24,icon:"solar:map-point-add-bold"})})})]}),e.jsx(B,{direction:"row",spacing:1,alignItems:"center",justifyContent:"center",children:e.jsx(ie,{title:"Asignar area",children:e.jsx(L,{edge:"end","aria-label":"asignar area",onClick:P=>I(P,E.deviceId,4),children:e.jsx(O,{width:24,icon:"solar:map-arrow-square-bold"})})})})]})}),e.jsx(A,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",gap:1},children:[E.deviceId," ",e.jsx(L,{onClick:P=>Me(P,E.deviceId),edge:"end",size:"small",children:e.jsx(O,{icon:"solar:copy-bold-duotone",width:15})})]})}),e.jsx(A,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",gap:1},children:[E!=null&&E.deviceName?E.deviceName:"Sin nombre",e.jsx(L,{onClick:P=>Me(P,E.deviceName||"Sin nombre"),size:"small",edge:"end",children:e.jsx(O,{icon:"solar:copy-bold-duotone",width:15})})]})}),e.jsx(A,{children:E.soilWater?`${E.soilWater}%`:"sin información"}),e.jsx(A,{children:E.soilTemperature?`${E.soilConductivity}µS/cm`:"sin información"}),e.jsx(A,{children:E.soilTemperature?`${E.soilTemperature}°C`:"sin información"}),e.jsx(A,{children:E.battery?`${E.battery}V`:"sin información"}),e.jsx(A,{children:ht(E.timestamp)})]},E.id))})]})}),e.jsx(Xt,{isOpen:g===2,handleClose:j,refetchAssignedSensors:C,selectedSensorId:v,alreadyAssignedIds:l}),e.jsx(Vt,{isOpen:g===3,handleClose:j,refetchDevices:r,selectedSensorId:v}),e.jsx(tn,{isOpen:g===0,handleClose:j,selectedSensorId:v}),e.jsx(Qt,{isOpen:g===1,handleClose:j,selectedSensorId:v}),e.jsx(Zt,{isOpen:g===4,handleClose:j,deviceId:v})]})},rn=({isOpen:t,onClose:r,name:n,stationId:s})=>{var T,m;const[a,i]=o.useState([]),[d,u]=o.useState([]),{data:h,refetch:f}=G({queryKey:["get-users-in-stations",s],queryFn:()=>Qs(s),enabled:!!s}),g=K({mutationKey:["assignToUser",s],mutationFn:({stationEui:l,ids:x})=>Ys(l,x),onSuccess:()=>{i([]),u([]),f()}}),p=K({mutationKey:["assignToUser",s],mutationFn:({stationEui:l,ids:x})=>Xs(l,x),onSuccess:()=>{i([]),u([]),f()}});o.useEffect(()=>{i([]),u([])},[s]);const v=l=>{const{target:{value:x}}=l;i(typeof x=="string"?x.split(","):x)},w=l=>{const{target:{value:x}}=l;u(typeof x=="string"?x.split(","):x)},b=()=>{if(a&&a.length>0){const l=a.map(Number);g.mutate({stationEui:s,ids:l})}if(d&&d.length>0){const l=d.map(Number);p.mutate({stationEui:s,ids:l})}};return e.jsx(re,{open:t,onClose:r,anchor:"right",children:e.jsx(ce,{children:e.jsxs(k,{sx:{width:{xs:300,sm:500,md:600},p:{xs:1.5,sm:4},height:"100vh"},children:[e.jsx(M,{variant:"subtitle1",children:n||"Sin nombre"}),e.jsx(M,{variant:"caption",children:"Asigna esta estación a usuarios"}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"assign-to-users",children:"Assignar usuarios"}),e.jsx(Y,{labelId:"assign-to-users",id:"assign-to-users",multiple:!0,value:a,onChange:v,input:e.jsx(ge,{label:"Assignar a usuarios"}),size:"small",renderValue:l=>e.jsx(k,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:l.map(x=>{var C;const j=(C=h==null?void 0:h.data.notAssigned)==null?void 0:C.find(I=>I.id.toString()===x);return e.jsx(xe,{label:(j==null?void 0:j.name)||x,size:"small"},x)})}),children:(T=h==null?void 0:h.data.notAssigned)==null?void 0:T.map(l=>e.jsx(Q,{value:l.id.toString(),children:l.name},l.id))})]}),e.jsxs(ee,{fullWidth:!0,sx:{mt:3},children:[e.jsx(se,{id:"assign-to-users",children:"Remover usuarios"}),e.jsx(Y,{labelId:"assign-to-users",id:"assign-to-users",multiple:!0,value:d,onChange:w,input:e.jsx(ge,{label:"Assignar a usuarios"}),size:"small",renderValue:()=>e.jsx(k,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:d.map(l=>{var j;const x=(j=h==null?void 0:h.data.assigned)==null?void 0:j.find(C=>C.id.toString()===l);return e.jsx(xe,{label:(x==null?void 0:x.name)||l,size:"small"},l)})}),children:(m=h==null?void 0:h.data.assigned)==null?void 0:m.map(l=>e.jsx(Q,{value:l.id.toString(),children:l.name},l.id))})]}),e.jsx(q,{variant:"contained",fullWidth:!0,sx:{mb:2,mt:2},onClick:b,loading:p.isPending||g.isPending,disabled:p.isPending||g.isPending,children:"Actualizar Estación"}),g.isError&&e.jsx(U,{message:`${g.error}`}),p.isError&&e.jsx(U,{message:`${g.error}`}),g.isSuccess&&e.jsx(H,{message:"Usuarios asignados"}),p.isSuccess&&e.jsx(H,{message:"Usuarios removidos"})]})})})},an=({station:t,setSelectedStation:r,idx:n})=>{const s=Ps();return e.jsxs(Ae,{sx:{cursor:"pointer","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"},backgroundColor:n%2===0?"rgba(255,255,255)":"rgba(250,250,250)"},onClick:()=>s.push(`/weather-stations/${t.station.devEui}`),children:[e.jsx(A,{children:e.jsx(L,{onClick:a=>{a.stopPropagation(),r({name:t.station.deviceName,id:t.station.devEui})},children:e.jsx(O,{icon:"solar:pen-bold-duotone"})})}),e.jsx(A,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",gap:1},children:[t.station.devEui,e.jsx(L,{onClick:a=>Me(a,t.station.devEui),size:"small",edge:"end",children:e.jsx(O,{icon:"solar:copy-bold-duotone",width:15})})]})}),e.jsx(A,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",gap:1},children:[t.latestData.deviceName,e.jsx(L,{onClick:a=>Me(a,t.latestData.deviceName),size:"small",edge:"end",children:e.jsx(O,{icon:"solar:copy-bold-duotone",width:15})})]})}),e.jsx(A,{children:t.station.grupoName}),e.jsxs(A,{children:[t.latestData.temperature,"°C"]}),e.jsxs(A,{children:[t.latestData.humidity,"%"]}),e.jsx(A,{children:t.latestData.light}),e.jsx(A,{children:t.latestData.uv}),e.jsx(A,{children:t.latestData.windSpeed}),e.jsx(A,{children:t.latestData.windDirection}),e.jsx(A,{children:t.latestData.rainfall}),e.jsx(A,{children:t.latestData.pressure}),e.jsx(A,{children:t.latestData.rssi}),e.jsx(A,{children:t.latestData.snr}),e.jsx(A,{children:xt(t.latestData.timestamp)})]},t.station.id)},on=({requestSort:t,getSortDirection:r})=>e.jsx(rs,{children:e.jsxs(Ae,{children:[e.jsx(A,{children:"Acciones"}),e.jsx(A,{children:"Id"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.deviceName",children:"Nombre del Dispositivo"}),e.jsx(A,{children:"Nombre del grupo"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.temperature",children:"Temperatura"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.humidity",children:"Humedad"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.light",children:"Intensidad de la luz"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.uv",children:"UV"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.windSpeed",children:"Velocidad del viento"}),e.jsx(A,{children:"Dirección del viento"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.rainfall",children:"Precipitación"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.pressure",children:"Presión"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.rssi",children:"rssi"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.snr",children:"snr"}),e.jsx(_,{requestSort:t,getSortDirection:r,sortKey:"latestData.timestamp",children:"Última actualización"})]})}),ln=()=>{const[t,r]=o.useState(null),{data:n,isLoading:s,isError:a,error:i}=G({queryKey:["admin-weather-stations"],queryFn:et}),{sortedData:d,requestSort:u,getSortDirection:h,validationErrors:f}=es(n==null?void 0:n.data,pt,{defaultSort:{key:"latestData.deviceName",direction:"asc"}});return f?e.jsx(U,{message:f.message}):s?e.jsx(ss,{}):a?e.jsx(U,{message:i.message}):e.jsxs(e.Fragment,{children:[e.jsx(ts,{component:X,sx:{mt:2},children:e.jsxs(ns,{children:[e.jsx(on,{requestSort:u,getSortDirection:h}),e.jsx(as,{children:d.map((g,p)=>e.jsx(an,{station:g,setSelectedStation:r,idx:p},g.station.id))})]})}),t!==null?e.jsx(rn,{isOpen:!0,onClose:()=>r(null),stationId:t.id,name:t.name}):null]})},cn=()=>{const[t,r]=o.useState(0),n=(s,a)=>{r(a)};return e.jsxs(Ms,{children:[e.jsx(M,{variant:"h4",children:"Sensores"}),e.jsxs(ft,{value:t,onChange:n,"aria-label":"vistas-disponibles",sx:{mt:3},variant:"scrollable",scrollButtons:"auto",children:[e.jsx(Re,{label:"Dispositivos",...Te(0),sx:{borderRadius:1,marginBottom:.5},icon:e.jsx(O,{icon:"solar:devices-bold-duotone"}),iconPosition:"start"}),e.jsx(Re,{label:"Ranchos",...Te(1),sx:{borderRadius:1,marginBottom:.5},icon:e.jsx(O,{icon:"solar:home-bold-duotone"}),iconPosition:"start"}),e.jsx(Re,{label:"Estaciones Meteorológicas",...Te(2),sx:{borderRadius:1,marginBottom:.5},icon:e.jsx(O,{icon:"solar:cloud-sun-bold-duotone"}),iconPosition:"start"}),e.jsx(Re,{label:"Parcelas",...Te(3),sx:{borderRadius:1,marginBottom:.5},icon:e.jsx(O,{icon:"uim:layer-group"}),iconPosition:"start"})]}),e.jsx(Ne,{value:t,index:0,children:e.jsx(nn,{})}),e.jsx(Ne,{value:t,index:1,children:e.jsx(At,{})}),e.jsx(Ne,{value:t,index:2,children:e.jsx(ln,{})}),e.jsx(Ne,{value:t,index:3,children:e.jsx(Bt,{})})]})};function Xn(){return e.jsxs(e.Fragment,{children:[e.jsx(Ds,{children:e.jsxs("title",{children:[" ",`Sensors - ${As.appName}`]})}),e.jsx(cn,{})]})}export{Xn as default};
